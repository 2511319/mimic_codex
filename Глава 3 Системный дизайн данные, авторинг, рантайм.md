# 3\. Системный дизайн: данные, авторинг, рантайм

Цель главы — дать разработчикам полный, самодостаточный набор спецификаций: **что это**, **зачем**, **когда и кем используется**, **где хранится**, **как связано**, **какие поля и инварианты**, **граничные случаи**, **ошибки и тесты**. Все решения согласованы по результатам Глав 1–2 и текущего диалога (VDM, Failsafe, квоты, TTL, Asset Cortex, матрица рас/классов и пр.).

## 3.0 Обзор

- **Платформа:** Telegram Mini App (mobile-first 360–414 px, тёмная тема, доступность).
- **Игровая модель:** Core-loop «3 варианта + “Свой ход”», fail-forward, Combat-Lite, голосование пати, Co-DM.
- **Скелеты:** граф узлов/рёбер (Node/Edge) + гибрид авторского и ИИ-контента (фикс-узлы + ИИ-связки).
- **VDM (Voice Dialogue Mode):** опционален для **Social**\-сцен и **Boss/Setpiece** (по флагу vdm:true), старт — VDM-Lite.
- **Медиа/квоты:** GEN-I/TTS по кнопке, подтверждения списаний, кэши и лимиты (см. 3.4).
- **Сессии/TTL:** Redis 24–72 ч (тёплая сессия), локальная кнопка «Продолжить» 7 дней (подсказка UI, холодное восстановление из БД при необходимости).

## 3.1 Модель данных (что/зачем/как)

### 3.1.1 Scene — атом повествования (RUN-сцена)

**Что это:** самодостаточное описание шага истории: текст, 3 выбора + «Свой ход», проверки/последствия, переходы, опциональные медиа (арт, TTS, VDM), настройки партии/режиссёра (DIR).

**Зачем:** единый формат для рантайма/редактора/ИИ; управляемый UX; проверяемые переходы (fail-forward); повторное использование лора/активов.

**Когда/кем:** автор/GM при создании; движок в исполнении; ИИ для контекста и подсказок.

**Где хранится:** content/scenes/\*.json + индексы в БД; опубликованные версии неизменяемы (SemVer).

**Связи:** Node/Edge (если сцена привязана к узлу), Lorebook/Assets (контекст/медиа), Director (DC-смещения), Inventory/Rewards (лут/ресурсы).

**Поля и инварианты:**

- mode: scene|combat|camp|boss|epilogue — влияет на UI/ярлыки ИИ.
- text.segments\[\] — абзацы (удобно для TTS/ленивой отрисовки).
- aiChips\[\] — whitelist видимых «ярлыков ИИ».
- **Инварианты:** ровно **3** choices + customAction.enabled=true; переходы всегда ведут к новой сцене/состоянию; все ссылки валидны.

**Граничные случаи и ошибки:**

- Нет медиа → текст первичен, кнопка GEN-I доступна.
- В пати ничья → d20/решение GM; таймер можно 1 раз продлить.
- Ошибка LLM/TTS/IMG → показать текст/кнопку «Повторить»/деградация (см. 3.4, Прил. Е).

**Тесты:**

- Снэпшоты рендера (RU/EN, тёмная тема).
- Валидатор переходов (нет тупиков).
- UI-тест «3 кнопки + Свой ход»; голосование/таймер.

**Пример:**

{

"sceneId": "S-001",

"mode": "scene",

"type": "Exploration",

"tone": "heroic_semidark",

"context": { "tags": \["ruins","dusk","undead"\], "loreRefs": \["loc:graveyard"\] },

"text": { "targetChars": 700, "segments": \[{ "id": "t1", "md": "Вы подходите к древнему кладбищу..." }\] },

"media": {

"image": { "policy": "preload_if_cached", "promptRef": "img:graveyard.v1" },

"tts": { "policy": "on_demand", "voice": "female_ru_heroic" },

"vdm": { "enabled": false }

},

"aiChips": \["ASK","RULE","LORE","GEN-I","GEN-T","GEN-V"\],

"resources": { "alarm": { "value": 1, "min": 0, "max": 5 }, "time": { "value": 3, "min": 0, "max": 10 }, "position": "neutral" },

"choices": \[

{ "id": "c1", "label": "Осмотреть аллею", "skillCheck": { "skill": "Внимательность", "dc": 12 }, "effects": \["tag:add:trail","alarm:-1"\] },

{ "id": "c2", "label": "Исследовать мавзолей", "skillCheck": { "skill": "Аркана", "dc": 14 }, "effects": \["spawn:hazard:gas"\] },

{ "id": "c3", "label": "Поставить дозор и отдохнуть", "skillCheck": { "skill": "Выживание", "dc": 10 }, "effects": \["hp:+1","status:inspired"\] }

\],

"customAction": { "enabled": true, "charLimit": 80, "rateLimit": "1_per_player_per_scene", "safeFilter": true },

"consequences": { "success": \["position:adv","alarm:-1","loot:roll:common"\], "partial": \["hp:-1","alarm:+1"\], "failure": \["position:disadv","spawn:ambush"\] },

"rewards": { "gold": 5, "items": \[{ "itemRef": "itm:grave_key", "rarity": "Uncommon" }\], "achievements": \["ach:first_steps"\] },

"party": { "votePolicy": "majority", "timerSeconds": 60 },

"directorHints": { "difficulty": "Balanced", "autoAdjustDC": true, "dcShiftMax": 2, "combatLikelihood": "low" },

"gates": \[{ "requires": { "item": "itm:grave_key" }, "onFail": "S-ALT-LOCKED" }\],

"next": { "onSuccess": "S-002", "onPartial": "S-001B", "onFailure": "S-AMBUSH" },

"audit": { "allowRetcon": true, "note": "v1 published" }

}

### 3.1.2 Node/Edge — скелеты приключений

**Что это:** граф-каркас модуля. Node — тип/цель узла, Edge — условия переходов (навык, ресурс, предмет, тэг, исход).

**Зачем:** дисциплина сюжета (без тупиков), быстрое прототипирование, Playtest; точка входа ИИ-дирижёра (генерирует связки между фикс-узлами).

**Когда/кем:** автор в редакторе; движок — при навигации; ИИ — для «мостиков» (GEN-T) между узлами.

**Где хранится:** content/skeletons/{adv_id}.json.

**Связи:** сцены (привязываются к узлам), лор/ассеты (теги узлов), Director (сложность).

**Поля/инварианты:**

- Node.type ∈ {Intro, Exploration, Social, Hazard, Puzzle, Travel, Stealth, Combat, Setpiece, Boss, Downtime, Twist, Reward, Epilogue}.
- Edge.condition\[\]: skill|resource|item|time|tag|outcome (+ Pro-режим: логика И/ИЛИ, веса/вероятности).
- Инвариант: **нет висячих узлов** (линтер).

**Пример:**

{ "id":"N1","type":"Social","title":"Гильдия перевозчиков","goal":"получить пропуск","skills":\["Убеждение","Проницательность"\],"tags":\["city","day"\],"vdm":{"enabled":true} }

{ "from":"N1","to":"N2","condition":\[{"type":"skill","name":"Убеждение","dc":12,"onFail":"N3"},{"type":"resource","name":"gold","gte":3}\] }

### 3.1.3 NPC — персонажи мира

**Что это:** сущность с мотивами/секретами/голосом и портретом; поддерживает VDM.

**Зачем:** консистентные диалоги/поведение; подбор голоса TTS; влияние матрицы рас/классов.

**Когда/кем:** автор/GM при подготовке; движок/ИИ — в Social/Boss; TTS — при озвучке.

**Где хранится:** content/npc/\*.json; портреты — assets/img.

**Связи:** ruleset.reaction_matrix, сцены Social/Boss, лор.

**Поля/инварианты:**

- motives\[\], secrets.easy|hard, voice (настройка TTS).
- overrides.reactionBias — частные исключения из матрицы.

**Матрица рас/классов (канон):**

ruleset: srd5e_v1

reaction_matrix:

dwarf: { elf: -1, orc: -2 }

elf: { orc: -1 }

apply_to: \[social_checks.dc\] # −1 → +1 DC, −2 → +2 DC (caps: ±2)

caps: { min: -2, max: +2 }

### 3.1.4 Item — предмет/лут

**Что это:** объект инвентаря с редкостью ×6, валидируемыми эффектами и флагами торговли/привязки.

**Зачем:** предсказуемые системные эффекты; визуальное единообразие; возможность торговли/биржи (в будущем).

**Когда/кем:** движок при дропе/применении; магазин/биржа; UI инвентаря.

**Где хранится:** content/items/\*.json.

**Связи:** Scene.rewards, Inventory, EffectEnum.

**Поля/инварианты:**

- rarity ∈ {Common, Uncommon, Rare, Epic, Legendary, Mythic}.
- effects\[\] только из EffectEnum v1.
- attunement: true учитывает лимит 3 «привязок».

**Пример:**

{ "itemId":"itm:grave_key","name":"Ключ от склепа","type":"tool","rarity":"Uncommon","tags":\["key","graveyard"\],

"soulbound":false,"tradeable":true,"effects":\[{"kind":"unlock_edge","target":"S-LOCKED-DOOR"},{"kind":"tag_add","value":"has_key"}\] }

**EffectEnum v1 (сокр.):** stat_mod, skill_advantage, add_status, heal_hp,  
resource_change(alarm|time|gold), tag_add|tag_remove, unlock_edge, spawn, grant_inspiration, damage.

### 3.1.5 Lorebook/Glossary — база знаний мира (авто-пополнение и переиспользование)

**Что это:** термины мира (локации, фракции, легенды) с краткими описаниями, ссылками на источники и связанными ассетами.

**Зачем:**

- Игрово — ярлык \[LORE\] отдаёт факты в сценах;
- Авторски — редактор предлагает готовые термины/арты вместо новой генерации;
- Экономически — повторное использование снижает косты.

**Когда/кем:** редактор/GM (подсказки); Co-DM (быстрые справки); ИИ (grounding).

**Где хранится:** content/lore/\*.json + БД + векторный индекс для поиска.

**Связи:** сцены (context.loreRefs), ассеты (галерея по термину), ярлык \[LORE\].

**Пример:**

{ "termId":"loc:graveyard","name":"Старое кладбище Равенхолда","summary":"Полузабытая территория к югу от города...",

"visibility":"player","tags":\["location","graveyard"\],"assets":\["img:graveyard.v1"\],"sources":\["adv:ravenshadow_v1"\] }

### 3.1.6 Локализация (ui.json / content.\*)

**Что это:** разделение UI-строк и контентных текстов по доменам.

**Зачем:** независимые циклы перевода, контроль качества, кеширование.

**Когда/кем:** фронт (i18n), сборка (pre-commit), переводчики.

**Где хранится:** i18n/ui.json, i18n/content.ru.json, i18n/content.en.json.

**Инварианты:** namespaced ключи (ui.menu.solo, content.scene.S-001.text.t1), плейсхолдеры {count} в обоих языках.

**Тесты:** скрипт «нет пропущенных ключей», регрессы длины строк.

## 3.2 Авторинг и публикация

### 3.2.1 Версии/статусы

- **SemVer (MAJOR.MINOR.PATCH)**; опубликованные билды иммутабельны.
- Внутренний autoRev (r123) — для диффов.
- Поток: Draft → Ready → Published.  
    Официальный контент — авто-валидаторы; **UGC** — пре-модерация + жалобы.

### 3.2.2 Линтеры/валидаторы v1

- Длины текста/кнопок; **ровно 3** выбора + «Свой ход».
- Запретные темы/лексика (SAFE).
- Валидность ссылок (loreRefs, itemRef, assets).
- Нет тупиков в графе.

(Эвристика тона — opt-in.)

### 3.2.3 Редактор/скелеты/Playtest

- Канвас узлов, инспектор полей, гейты (DC/ресурс/время/предмет/тэг/исход).
- Библиотека 8–12 шаблонов + «пустой скелет».
- Pro-режим: rule-DSL для рёбер (И/ИЛИ, веса/вероятности).
- **Playtest:** псевдо-партия прогоняет граф без игроков.

### 3.2.4 Плагины ИИ (с квотами)

- GEN-T, GEN-I, GEN-NPC, GEN-MAP, REWRITE, RULE/LORE/FIND.
- Кнопки генераций с подтверждением списаний; очереди/ретраи при лимитах.

### 3.2.5 Asset Vault & Asset Cortex

- **Vault:** IMG/AUDIO/JSON с метаданными (теги, лицензия, hash-dedup).
- **Cortex:** embeddings-поиск, near-dup merge, quality-score, **авто-архив 90 дней** неиспользуемых ассетов, **trust-уровни** авторов:
    - **T0 New** — малые квоты, видимость «только автор/модерация».
    - **T1 Trusted** — ≥3 одобрений: выше квоты, попадает в общие «Suggested».
    - **T2 Curator** — ≥10 одобрений и ≥5 ассетов, использованных другими: merge дублей/правка тегов.
- UX: при запросе «кладбище» редактор показывает Top-5 готовых ассетов (теги/лицензия/использовать) + кнопку «Сгенерировать новое».

## 3.3 Рантайм-движок

### 3.3.1 Состояния

\[INIT\] → \[SCENE\] ↔ \[COMBAT\] → \[LOOT/LEVELUP\] → \[SCENE\] … → \[EPILOGUE|END\]

\\\___\__ \[CAMP/DOWNTIME\] \___\__/

Категории, а не «линейка». Нелинейность задана графом (Node/Edge/gates). mode сцены переключает UI/ярлыки.

### 3.3.2 Сложность/Director

- База DC: **8 / 12 / 16 / 20**.
- DIR-смещения: Story −2, Balanced 0, Challenge +2; кап ±2.
- Матрица рас/классов (Social): −1 → +1 DC; −2 → +2 DC (caps: ±2).

### 3.3.3 Fail-forward + Failsafe Gate

- Всегда новая сцена (кроме смерти).
- **Failsafe** (Story-tone, флаг модуля): **1** срабатывание в коротком, **2** — в длинном модуле; «спасительный» поворот **с ценой** (утрата/репутация/время); логируется; отключён в Challenge/Hardcore.

### 3.3.4 «Свой ход» и голосование

- «Свой ход»: ≤80 символов, 1 на игрока/сцену, SAFE-фильтр, анти-спам; участвует в голосовании.
- Голосование: простое большинство; ничья — d20/GM; таймер 15–180 с, 1 продление +45 с.

### 3.3.5 Retcon/Override

- Retcon **≤1 шаг**, запрещён если были платные/NFT-эффекты.
- Override — только с причиной; всё в аудит-лог.

## 3.4 Медиа/голос, квоты и кэш

### 3.4.1 GEN-I (изображения)

- По кнопке; предзагрузка **только** если ассет уже в кеше (Cortex).
- Подтверждение списаний (Stars/юниты).
- Лимиты: ≤1 авто-фон/сцену (кеш), ≤2 ручных/сцену; ≤20/кампанию/день; очереди/ретраи.
- «All-in» флаг: HQ-пакет (фон/портрет/предмет) по повышенной цене.
- CDN signed URLs, TTL 30 дн., инвалидация по версии.

### 3.4.2 TTS (озвучка)

- По кнопке; авто — только если включено юзером.
- Кэш 7–30 дн. (ключ: хеш текста + голос).

### 3.4.3 VDM — голосовой диалог с NPC

- Покрытие: **Social** и **Boss/Setpiece** сцены при vdm:true.
- Старт: **VDM-Lite** (пошаговый; без стриминга).
- Флоу: пати голосует переговорщика → запись ≤15 c → STT → NLU/LLM → реплика NPC (текст) → TTS ≤20 c → слышат все → 3–5 обменов → возврат к «3+Свой».
- Квоты: ≤10 обменов/сессию; STT ≤15 c; TTS ≤20 c.
- SLA p95: STT ≤1.2 c; LLM ≤1.5 c; TTS ≤1.0 c; общий RTT ≤3.5 c; деградация — сразу показать текст, TTS догрузить.
- Безопасность: мат-фильтр до LLM, SAFE после; хранение аудио ограничено TTL.

**WS-события (добавка):** vdm.start, vdm.turn_request, vdm.turn_transcript, vdm.npc_reply_text, vdm.npc_reply_audio_ready, vdm.end, vdm.error.

## 3.5 Синхронизация, сессии, оффлайн

### 3.5.1 Протокол

- **WebSocket**: state_delta, vote_update, timer_tick, gm_action, media_ready, vdm.\*, error.
- **Fallback**: long-poll /sync?since=….

**Пример:**

{ "type":"state_delta","campaignId":"c_42","step":123,"prevStep":122,"mode":"scene","sceneId":"S-001B","lockVersion":17,"timestamp":1732636400 }

### 3.5.2 Сессии/TTL — как работает восстановление

- **Redis-сессия** (таймеры/голоса/активная сцена): TTL **24–72 ч** неактивности (любое действие продлевает). Возврат в течение TTL — **мгновенный**.
- **Локальная кнопка «Продолжить»**: TTL **7 дней** — отображается без запроса к серверу; если Redis умер, при нажатии восстановим **из БД** (холодно, чуть медленнее).

### 3.5.3 Оффлайн и конкурентность

- **Соло:** 1 буферованное действие; при конфликте — «Повторить/Откатить».
- **Пати:** read-only при оффлайне; голос/действия недоступны; таймер не ждёт.
- **Locking:** optimistic-lock по версии шага; решение — по кворуму/таймеру.

## 3.6 Безопасность, модерация, права

- **SAFE + Lines&Veils**: фильтры тем/лексики и персональные «линии/завесы».
- **UGC:** офиц. — авто-валидаторы; пользовательский — **пре-модерация** + жалобы.
- **Лицензии:** обязательные поля у ассетов; запрет внешних IP без прав.
- **Анти-абьюз:** rate-limits на «Свой ход», мут/кик хостом, фильтр обсценной лексики.

## 3.7 Локализация и терминология

- Раздельные домены: ui.json (интерфейс) и content.\* (сцены/лор/наименования).
- **Глоссарий SRD:** закреплённые переводы (Ability Scores, Skills, Advantage/Disadvantage, Saving Throw, HP и др.).
- Pre-commit на пропущенные ключи; проверка длины строк (узкие экраны).

## 3.8 Телеметрия, A/B, QA

- **События:** ui.view, run.choice.submit, run.vote.submit, combat.action, image.gen, tts.play, gm.override, retcon.use, error.net, error.llm, latency.\*.
- **Метрики:** средняя длина сцены, время на ход, доля частичных успехов, % боёв, AFK-rate.
- **A/B:** флаги по пользователю/кампании; **не** влияют на шансы/баланс.
- **QA:** симулятор пати, фиктивные броски, детальный трейс, snapshot-тесты.

## 3.9 Журналы, аудит, алерты

- **Журнал игрока:** сцены/броски/лут; фильтры; экспорт (JSON/HTML).
- **Аудит (GM/система):** publish, override(reason), retcon, таймер/пауза, кик, квоты медиа, VDM-сессии.
- **Алерты/деградация:** LLM/TTS/IMG-ошибки → автоматическое отключение авто-арта; статус-страница.

## 3.10 DoR / DoD и артефакты

**DoR (готовность):**

- Утверждены схемы: Scene/Node/Edge/NPC/Item/Lore; whitelist EffectEnum/AIChips.
- Авторинг: SemVer + Draft→Ready→Published; линтеры; модерация UGC.
- Рантайм: DC-база 8/12/16/20; DIR ±2; матрица рас/классов; Failsafe 1/2; Retcon≤1; Override с причиной.
- Медиа: GEN-I/TTS квоты; CDN TTL 30 дн.; VDM-Lite (Social & Boss/Setpiece).
- Синхронизация: WS + fallback; Redis TTL 24–72 ч; локальное «Продолжить» 7 дн.; оффлайн-буфер (соло).
- Безопасность: SAFE/Lines&Veils; лицензии; анти-абьюз.
- i18n/глоссарий SRD; аналитика/QA; журналы/аудит; Asset Cortex (архив 90 дн., trust уровни).

**DoD (выпуск):**

- schemas/\*.json: scene/node/edge/npc/item/lore.
- schemas/enums/effects.v1.json, schemas/enums/aichips.v1.json.
- diagrams/state_machine.svg, diagrams/ws_events.md.
- editor/validators.md, editor/playtest.md.
- runtime/director.config.yaml (включая матрицу рас/классов).
- media/policies.md (GEN-I/TTS/CDN/All-in).
- sync/protocol.md (WS/REST, payload).
- security/moderation.md (SAFE/UGC/лицензии/анти-абьюз).
- i18n/ui.json, i18n/content.\*, i18n/glossary_srd.md.
- analytics/events.md, qa/simulator.md, qa/snapshots.md.
- logs/journal_user.md, logs/audit_gm.md, ops/alerts.md.
- asset_cortex/policy.md (архив 90 дн., trust-уровни T0/T1/T2 и пороги).

## Приложения

### Прил. A — Whitelists (фрагменты)

// enums/aichips.v1.json

{ "enum": \["ASK","TACT","COACH","RECOM","RULE","LORE","EXPL","SUMM","TRAN","GEN-T","GEN-I","GEN-V","GEN-MAP","GEN-NPC","REWRITE"\] }

// enums/effects.v1.json

{ "enum": \["stat_mod","skill_advantage","add_status","heal_hp","resource_change","tag_add","tag_remove","unlock_edge","spawn","grant_inspiration","damage"\] }

### Прил. B — WS-события (справка)

- state_delta {campaignId, step, prevStep, mode, sceneId, lockVersion, timestamp}
- vote_update {campaignId, sceneId, optionId, userId, tally}
- timer_tick {campaignId, sceneId, secondsLeft}
- gm_action {type:"override|pause|retcon|kick", ...}
- media_ready {sceneId, kind:"image|tts", url}
- vdm.start|vdm.turn_request|vdm.turn_transcript|vdm.npc_reply_text|vdm.npc_reply_audio_ready|vdm.end|vdm.error
- error {code, message, retryAfterMs?}

### Прил. C — Director-config (пример)

director:

mode: Balanced # Story | Balanced | Challenge

dc_base: { easy: 8, standard: 12, hard: 16, vhard: 20 }

dc_shift: { Story: -2, Balanced: 0, Challenge: +2 }

combat_likelihood: low

failsafe:

enabled: true

budget: 1 # 2 для длинных модулей

### Прил. D — Rate-limits (дефолты)

| **Объект** | **Лимит** |
| --- | --- |
| «Свой ход» | ≤1/игрок/сцена; длина ≤80 символов |
| GEN-I | ≤1 авто(кеш)/сцена; ≤2 ручных/сцена |
| GEN-I/сутки | ≤20 на кампанию |
| VDM | ≤10 обменов/сессию |
| STT/TTS | STT ≤15 с; TTS ≤20 с/реплика |

### Прил. E — Коды ошибок/деградации

- IMG_QUOTA_EXCEEDED → отключить авто-арт; оставить GEN-I по кнопке.
- TTS_TIMEOUT → сразу показать текст, TTS догрузить; toast.
- WS_DISCONNECTED → реконнекты; fallback long-poll.
- SAFE_BLOCKED → мягкая замена/редакция текста; запись в аудит.

## Краткий глоссарий

**Scene** — сценарный шаг; **Node/Edge** — узлы и рёбра графа; **Director** — автокалибровка сложности (DC ±2); **Failsafe Gate** — ограниченный «спасительный» поворот (Story-tone) с ценой; **VDM** — голосовой диалог с NPC (Social/Boss/Setpiece); **Asset Vault/Cortex** — хранилище и «мозг» ассетов; **SAFE / Lines&Veils** — фильтры/границы контента; **A/B** — фичефлаги без влияния на шансы; **Retcon/Override** — откат/вмешательство с аудитом.