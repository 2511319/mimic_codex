# Глава 10 — Рекомендации по кодовой базе и процессу

Эта глава — «операционализатор» всех предыдущих (1–9). Она задаёт единый каркас для разработки агентом-разработчиком (AugmentCode) и команды, чтобы получить предсказуемую скорость, качество и безопасность. Ниже — принципы, структура репозитория, стандарты кода, проверки, CI/CD, релизы, наблюдаемость, безопасность цепочки поставки и артефакты. Глава согласована с «Память37» (гл. 8) и «Генеративными слоями» (гл. 9).

## 1) Принципы процесса

- **Транк-ориентированная разработка (TBD)** + короткоживущие feature-ветки (≤2–3 дн.), релизуемость «главной» ветки в любой момент. Это снижает риск «merge-ада» и ускоряет поставку. Используем feature-flags для изоляции незавершённых фич без расщепления ветвления.
- **Код-ревью как средство улучшения «здоровья кода»**, с критериями «лучше, чем было» вместо «идеально». Берём ориентиры из открытой методологии Google.
- **Автоматизация релизов** на базе **SemVer 2.0.0** + **Conventional Commits** → детерминированное определение версии и генерация заметок релиза (**semantic-release / python-semantic-release**). Также ведём человекочитаемый CHANGELOG по **Keep a Changelog**.
- **Контракты-вперед (contracts-first)**: API оформляем как **OpenAPI 3.1** (+ JSON Schema) и валидируем линтером **Spectral**; из API-описаний генерируем SDK/доки.
- **12-факторные** практики для сервисов (конфигурация через переменные окружения, статeless-процессы, сбор логов и т. д.).

## 2) Архитектура репозитория и модульность

**Моно-репозиторий** (если не оговорено иное в гл. 3) с рабочими пространствами:

/apps

/tg-mini-app # Telegram Mini App (WebApp)

/orchestrator # backend-оркестр, FastAPI / Cloud Functions

/content-tools # оффлайн-авторинг (скрипты)

/packages

/memory37 # библиотека памяти (гл. 8)

/genlayers # генеративные слои (гл. 9)

/contracts

openapi.yaml # OpenAPI 3.1

spectral.yaml # правила линтинга API

/docs

ADRs/ # архитектурные решения

CHANGELOG.md

.github/ # CI/CD (Actions, issue/PR templates)

**ADRs** фиксируют ключевые решения и компромиссы, чтобы агент не «терял» контекст — один ADR на решение. (Лучшие практики ADR общеизвестны; включите шаблон в /docs/ADRs/0000-template.md.)

## 3) Языковые стандарты и форматирование

### Python (бэкенд/инструменты)

- **Ruff** как линтер (включаем базовые F/E-правила и расширяем по необходимости), **Black** или **Ruff Formatter** как форматтер (оба «жёсткие» и малоконфигурируемые — меньше священных войн).
- Управление зависимостями — **Poetry** (pyproject.toml, lockfile, изоляция).

### TypeScript (клиент WebApp / скрипты)

- Включаем **"strict": true** в tsconfig.json и используем **typescript-eslint** (flat config, recommended + strict-type-checked).

**Единые правила форматирования** и линтинга фиксируем в корневых конфиг-файлах и enforce’им через pre-commit/CI.

## 4) Коммиты, релизы и версии

- **Conventional Commits** (feat:, fix:, perf:, refactor:, docs:, ci:, build:, с BREAKING CHANGE: в теле). Это позволяет инструментам понять тип изменений.
- **SemVer 2.0.0** для публичных артефактов: MAJOR.MINOR.PATCH.
- **semantic-release** (JS) / **python-semantic-release** (Py) автогенерируют версию/релиз-ноты + GitHub Releases/теги.
- **CHANGELOG** — формат **Keep a Changelog**. Раздел Unreleased поддерживается автоматически при релизе.

## 5) Контракты API и генерация SDK

- Источник истины — **/contracts/openapi.yaml (OpenAPI 3.1)**.
- Проверка: spectral lint contracts/openapi.yaml по базовым правилам spectral:oas + кастом-гайд.
- Генерация SDK/доков — **OpenAPI Generator** (CLI/Node).

## 6) Тест-стратегия (пирамидальная)

- **Юнит-тесты** (основа) для домена, «Память37», адаптеров генеративных слоёв.
- **Контракт-тесты** для API (потребитель-ведомые, при необходимости — Pact). ([Medium](https://okorkmaz.medium.com/adr-deep-dive-into-architecture-decision-records-8c110ce7d74e?utm_source=chatgpt.com"%20\o%20"ADR:%20Deep%20Dive%20into%20Architecture%20Decision%20Records))
- **Интеграционные** с «тонкими» фикстурами и демо-конфигами.
- **E2E** — только критические сценарии (Telegram Mini App ↔ бекенд ↔ OpenAI).

## 7) Наблюдаемость и перфоманс

- **OpenTelemetry**: трассировки, метрики и логи по спецификации/семантическим соглашениям (HTTP stable) → экспорт в выбранный бекенд (OTLP). Для FastAPI есть готовая автоинструментация.
- Бюджеты перфоманса: p95 латентность ключевых операций, ошибка генерации < X %, кэш-хиты ≥ Y %. (Метрики и дистрибуции — через OTel.)

## 8) CI/CD (GitHub Actions) и окружения

**Цели:** быстрые обратные связи, детерминированные сборки, безопасные деплойменты.

- **Матрицы** для многоверсийных тестов (Python/Node/OS).
- **Кэширование зависимостей** для ускорения прогонов (actions/cache, hash по lock-файлам).
- **Environments** с required reviewers/таймерами для ручного допуска на prod.
- **OIDC-федерация** GitHub ↔ Cloud (напр., AWS) вместо статических ключей (наилучшая практика, минимизация утечек).
- **Стратегии выката**: blue/green для бэкенда и/или базы (где применимо), canary для веба/маршрутизации трафика

**Пайплайны (минимум):**

1.  **ci.yml** — линт/формат/тест/контракты/пакеты + кэш.
2.  **release.yml** — semantic-release → теги, GitHub Release, CHANGELOG.
3.  **deploy.yml** — образ/функция, прогон smoke, выкат по средам с approval-гейтами.

## 9) Безопасность и секреты

- **Запрет коммита секретов**: пред-коммит-сканы (ggshield / gitleaks / git-secrets) и сканы в CI.
- **Шифрование конфигов** (если хранится в Git) — **Mozilla SOPS** с KMS/PGP/AGE; подходят GitOps-потоки и Kubernetes-секреты.
- **OIDC** в CI вместо статических ключей (см. § 8).

## 10) Цепочка поставки и соответствие

- **SBOM** (CycloneDX/SpDX) — генерация, прикрепление к релизу (например, Syft).
- **Vuln-скан** артефактов/образов (Grype/Trivy) как обязательный gate.
- **Автообновления** зависимостей (Dependabot) с вайтлистом.

## 11) Управление артефактами

- **Релиз-артефакты**: Docker-образы/архивы, с подписью и SBOM, хранятся во внешнем реестре/хранилище; Git — только исходники. (Практика общеизвестна; следуем требованиям платформы деплоя.)

## 12) Шаблоны задач и PR-процессы

- **PR-template** и **Issue-templates** в .github/ упорядочивают описание изменений, тест-кейсов, рисков.
- **CODEOWNERS** + защищённые ветки и обязательные статусы (линт/тест/контракты) перед merge.

## 13) Интеграция «Память37» и ген-слоёв в коде

- **/packages/memory37** — чистая библиотека с явными интерфейсами:
    - адаптеры хранилищ (вектор/ключ-значение), полиси-слой (ретеншн, приватность), индексы, тестовые стаб-бэкенды;
    - **контракт наблюдаемости**: эмит атрибутов OTel (span attributes для запросов к памяти/кэшу, счётчики попаданий/промахов).
- **/packages/genlayers** — маршрутизатор промптов, политики «безопасного» генератива, post-processors, контроль качества (детект регрессий по golden-сетам; см. гл. 9).

## 14) Проверяемые «готовые условия» (Definition of Done)

1.  Линтеры/форматтеры чисты; юнит- и контракт-тесты зелёные.
2.  OpenAPI 3.1 валиден и пролинтен; изменения отражены в SDK/доках.
3.  Покрытие ключевого домена ≥ минимального порога.
4.  Релиз-заметки сгенерированы; CHANGELOG обновлён.
5.  Образы подписаны; SBOM прикреплён; vuln-скан пройден.
6.  OTel-трассы появляются в бекенде, ключевые метрики видны.

## 15) Мини-руководства по конфигам (фрагменты)

**.pre-commit-config.yaml (Python + секреты):**

repos:

\- repo: https://github.com/astral-sh/ruff-pre-commit

rev: v0.6.0

hooks: \[{ id: ruff }, { id: ruff-format }\]

\- repo: https://github.com/psf/black

rev: 25.1.0

hooks: \[{ id: black }\]

\- repo: https://github.com/gitguardian/ggshield

rev: v1.32.0

hooks: \[{ id: ggshield-secret-scan }\]

(Правила Ruff/Black — см. офиц. доки.)

**eslint.config.mjs (TS strict + typescript-eslint):**

// @ts-check

import eslint from '@eslint/js';

import tseslint from 'typescript-eslint';

export default tseslint.config(

eslint.configs.recommended,

tseslint.configs.recommended, // базовый набор

tseslint.configs.strictTypeChecked, // ужесточённый

{

files: \['\*\*/\*.ts', '\*\*/\*.tsx'\],

languageOptions: { parserOptions: { project: \['./tsconfig.json'\] } },

rules: {

// пример точечной жёсткости

'@typescript-eslint/explicit-function-return-type': 'error',

},

}

);

**tsconfig.json (фрагмент):**

{

"compilerOptions": {

"strict": true,

"alwaysStrict": true,

"noUncheckedIndexedAccess": true

}

}

([TypeScript](https://www.typescriptlang.org/tsconfig/strict.html?utm_source=chatgpt.com"%20\o%20"TSConfig%20Option:%20strict))

**Spectral (/contracts/spectral.yaml):**

extends: \["spectral:oas"\]

rules:

operation-tags: { given: "$.paths\[\*\]\[\*\]", then: { field: "tags", function: truthy } }

info-contact: { given: "$.info.contact", then: { function: truthy } }

([docs.stoplight.io](https://docs.stoplight.io/docs/spectral/4dec24461f3af-open-api-rules?utm_source=chatgpt.com))

**GitHub Actions — кэш, матрица, OIDC (фрагмент):**

name: ci

on: \[push, pull_request\]

jobs:

test:

runs-on: ubuntu-latest

strategy:

matrix:

python: \['3.11', '3.12'\]

node: \['20', '22'\]

steps:

\- uses: actions/checkout@v4

\- uses: actions/setup-python@v5

with: { python-version: ${{ matrix.python }} }

\- uses: actions/setup-node@v4

with: { node-version: ${{ matrix.node }} }

\- uses: actions/cache@v4

with:

path: ~/.cache/pip

key: pip-${{ runner.os }}-${{ hashFiles('\*\*/poetry.lock') }}

\- run: pipx install poetry && poetry install --no-interaction

\- run: poetry run pytest -q

deploy:

needs: test

environment: production

runs-on: ubuntu-latest

permissions:

id-token: write # OIDC

contents: read

steps:

\- uses: actions/checkout@v4

\- uses: aws-actions/configure-aws-credentials@v4

with:

role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

aws-region: ${{ secrets.AWS_REGION }}

\- run: ./scripts/deploy.sh

**PR-шаблон (.github/pull_request_template.md)** — чеклист: описание, мотивация, скоп, тест-кейсы, риски/флаги, скриншоты, «память/канон» (если затронут).

## 16) Документация и знания

- **ADRs** — для решений, **README** каждого пакета, **/docs** с онбордингом агента и ссылками на главы 1–9.
- **Автоген доков API** из OpenAPI (редактор/статические страницы).

## 17) Мини-гайд по деплою

- **Blue/Green** для критичных сервисов (две одинаковые среды, быстрый откат).
- **Canary** для поэтапной прогонки трафика на новую версию; при деградации — автоматический rollback.

## 18) Роли и чек-поинты

- **Agent (AugmentCode)**: следует правилам этой главы, создаёт/обновляет ADR, уважает контракты и «Память37», прикладывает артефакты к PR.
- **Чек-поинты**: «Контракт/Линт/Тесты/OTel/Безопасность/Релиз-метаданные/Отчёт по “Память37”». Любое «красное» — стоп-мерж.

## 19) Как это снижает риски и ускоряет разработку

- TBD + feature-flags и авто-релизы убирают «ручные тормоза» и очереди на релиз.
- Контракты-вперед и Spectral уменьшают регрессии интеграций.
- OIDC, SOPS и секрет-сканеры закрывают класс утечек.
- OTel даёт прозрачность деградаций, ускоряет RCA.