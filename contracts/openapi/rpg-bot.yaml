openapi: 3.1.0
info:
  title: RPG-Bot Gateway API
  version: 1.0.0
  contact:
    name: RPG-Bot Engineering
    url: https://rpg-bot.example/docs
  description: |
    REST API для Telegram Mini App. Поддерживает обмен initData на JWT и проверку состояния сервиса.
servers:
  - url: https://api.rpg.bot/v1
    description: Production
  - url: https://staging.api.rpg.bot/v1
    description: Staging
tags:
  - name: auth
    description: Authentication flows for Telegram Mini App.
  - name: system
    description: Operational endpoints exposing health and configuration.
  - name: knowledge
    description: Knowledge search powered by Memory37.
  - name: generation
    description: Low-level structured generation endpoints.
  - name: generate
    description: Domain-level generation endpoints using Memory37 context.
paths:
  /v1/auth/telegram:
    post:
      summary: Exchange initData for access token
      description: >
        Validates Telegram initData payload, applies idempotency guarantees and returns a short-lived
        JWT that authenticates the player session in the Mini App.
      operationId: exchangeInitData
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ../jsonschema/telegram_auth_request.schema.json
      responses:
        "200":
          description: Successful exchange
          content:
            application/json:
              schema:
                $ref: ../jsonschema/telegram_auth_response.schema.json
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /health:
    get:
      summary: Service healthcheck
      description: Returns service readiness along with API version.
      operationId: readHealth
      tags: [system]
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Health"
  /v1/knowledge/search:
    get:
      summary: Search knowledge base
      tags: [knowledge]
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
            minLength: 2
        - in: query
          name: top_k
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 20
          description: Number of results to return
      responses:
        "200":
          description: Knowledge search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/KnowledgeItem"
  /v1/generation/{profile}:
    post:
      summary: Structured generation by profile
      tags: [generation]
      parameters:
        - in: path
          name: profile
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GenerationRequest"
      responses:
        "200":
          description: Generation payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenerationResponse"
        "404":
          description: Profile not found
        "503":
          description: Service unavailable
  /v1/generation/profiles:
    get:
      summary: List generation profiles
      tags: [generation]
      responses:
        "200":
          description: Available profiles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenerationProfiles"
        "503":
          description: Service unavailable
  /v1/generation/profiles/{profile}:
    get:
      summary: Profile detail
      tags: [generation]
      parameters:
        - in: path
          name: profile
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Profile detail including response schema
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GenerationProfileDetail"
        "404":
          description: Profile not found
        "503":
          description: Service unavailable
  /v1/generate/scene:
    post:
      summary: Generate scene content
      tags: [generate]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SceneGenerateRequest"
      responses:
        "200":
          description: Structured scene payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SceneGenerateResponse"
        "503":
          description: Generation unavailable
  /v1/generate/combat:
    post:
      summary: Generate combat content
      tags: [generate]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SceneGenerateRequest"
      responses:
        "200":
          description: Structured combat payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SceneGenerateResponse"
  /v1/generate/social:
    post:
      summary: Generate social interaction
      tags: [generate]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SceneGenerateRequest"
      responses:
        "200":
          description: Structured social payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SceneGenerateResponse"
  /v1/generate/epilogue:
    post:
      summary: Generate epilogue content
      tags: [generate]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SceneGenerateRequest"
      responses:
        "200":
          description: Structured epilogue payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SceneGenerateResponse"
  /v1/me:
    get:
      summary: Current player profile
      tags: [players]
      responses:
        "200":
          description: Player profile with characters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          description: Unauthorized
  /v1/characters:
    get:
      summary: List characters for current player
      tags: [characters]
      responses:
        "200":
          description: Characters
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Character"
        "401":
          description: Unauthorized
    post:
      summary: Create character
      tags: [characters]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CharacterCreateRequest"
      responses:
        "201":
          description: Created character
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "401":
          description: Unauthorized
  /v1/characters/{characterId}:
    patch:
      summary: Update character
      tags: [characters]
      parameters:
        - in: path
          name: characterId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CharacterUpdateRequest"
      responses:
        "200":
          description: Updated character
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found
  /v1/characters/{characterId}/retire:
    post:
      summary: Retire character
      tags: [characters]
      parameters:
        - in: path
          name: characterId
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Retired character
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found
  /v1/parties:
    get:
      summary: List parties for current player
      tags: [parties]
      responses:
        "200":
          description: Parties
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Party"
        "401":
          description: Unauthorized
    post:
      summary: Create party
      tags: [parties]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartyCreateRequest"
      responses:
        "201":
          description: Created party
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Party"
        "401":
          description: Unauthorized
        "404":
          description: Character not found
        "403":
          description: Forbidden
  /v1/parties/{partyId}/join:
    post:
      summary: Join party
      tags: [parties]
      parameters:
        - in: path
          name: partyId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartyMemberRequest"
      responses:
        "200":
          description: Joined
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found
  /v1/parties/{partyId}/leave:
    post:
      summary: Leave party
      tags: [parties]
      parameters:
        - in: path
          name: partyId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartyMemberRequest"
      responses:
        "200":
          description: Left
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found
  /v1/campaigns:
    get:
      summary: List available campaign templates
      tags: [campaigns]
      responses:
        "200":
          description: Campaign templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/CampaignTemplate"
  /v1/campaign-runs:
    post:
      summary: Start campaign run
      tags: [campaigns]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CampaignRunCreateRequest"
      responses:
        "201":
          description: Campaign run started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CampaignRun"
        "400":
          description: Bad request
        "401":
          description: Unauthorized
        "403":
          description: Forbidden
        "404":
          description: Not found
  /v1/campaign-runs/{runId}:
    get:
      summary: Get campaign run state
      tags: [campaigns]
      parameters:
        - in: path
          name: runId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Campaign run
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CampaignRun"
        "404":
          description: Not found
  /v1/campaign-runs/{runId}/action:
    post:
      summary: Apply player action
      tags: [campaigns]
      parameters:
        - in: path
          name: runId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CampaignActionRequest"
      responses:
        "200":
          description: Updated run state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CampaignRun"
        "403":
          description: Forbidden
        "404":
          description: Not found
  /v1/campaign-runs/{runId}/summary:
    get:
      summary: Get campaign summary and retcon package
      tags: [campaigns]
      parameters:
        - in: path
          name: runId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Adventure summary and retcon package
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CampaignSummaryResponse"
        "404":
          description: Not found
components:
  schemas:
    Health:
      type: object
      required: [status, api_version]
      properties:
        status:
          type: string
          enum: [ok]
        api_version:
          type: string
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
    GenerationRequest:
      type: object
      required: [prompt]
      properties:
        prompt:
          type: string
          minLength: 2
    GenerationResponse:
      type: object
      required: [profile, result]
      properties:
        profile:
          type: string
        result:
          type: object
    GenerationProfiles:
      type: object
      properties:
        profiles:
          type: array
          items:
            type: string
    GenerationProfileDetail:
      type: object
      properties:
        profile:
          type: string
        temperature:
          type: number
        maxOutputTokens:
          type: integer
        responseSchema:
          type: object
    KnowledgeItem:
      type: object
      required: [item_id, score, content_snippet, metadata]
      properties:
        item_id:
          type: string
        score:
          type: number
        content_snippet:
          type: string
        metadata:
          type: object
    SceneGenerateRequest:
      type: object
      required: [prompt]
      properties:
        prompt:
          type: string
          minLength: 2
        campaignId:
          type: string
        partyId:
          type: string
        sceneId:
          type: string
        language:
          type: string
    SceneGenerateResponse:
      type: object
      required: [profile, result, knowledgeItems]
      properties:
        profile:
          type: string
        result:
          $ref: ../jsonschema/scene_response.schema.json
        knowledgeItems:
          type: array
          items:
            $ref: "#/components/schemas/KnowledgeItem"
    PlayerProfile:
      type: object
      required: [id, telegramId, displayName, createdAt, lastLoginAt]
      properties:
        id: { type: integer }
        telegramId: { type: integer }
        displayName: { type: string }
        settings: { type: object }
        createdAt: { type: string, format: date-time }
        lastLoginAt: { type: string, format: date-time }
    Character:
      type: object
      required: [id, playerId, name, archetype, level, xp, status, createdAt, updatedAt]
      properties:
        id: { type: integer }
        playerId: { type: integer }
        name: { type: string }
        archetype: { type: string }
        race: { type: string, nullable: true }
        level: { type: integer }
        xp: { type: integer }
        coreStats: { type: object }
        skills: { type: object }
        inventoryRef: { type: string, nullable: true }
        status: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    CharacterCreateRequest:
      type: object
      required: [name, archetype]
      properties:
        name: { type: string }
        archetype: { type: string }
        race: { type: string }
        coreStats: { type: object }
        skills: { type: object }
    CharacterUpdateRequest:
      type: object
      properties:
        name: { type: string }
        archetype: { type: string }
        race: { type: string }
    Party:
      type: object
      required: [id, leaderCharacterId, createdAt]
      properties:
        id: { type: integer }
        name: { type: string }
        leaderCharacterId: { type: integer }
        activeCampaignRunId: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
    PartyCreateRequest:
      type: object
      required: [leaderCharacterId]
      properties:
        name: { type: string }
        leaderCharacterId: { type: integer }
    PartyMemberRequest:
      type: object
      required: [characterId]
      properties:
        characterId: { type: integer }
    MeResponse:
      type: object
      required: [player, characters]
      properties:
        player:
          $ref: "#/components/schemas/PlayerProfile"
        characters:
          type: array
          items:
            $ref: "#/components/schemas/Character"
    CampaignTemplate:
      type: object
      required: [id, title, description, seasonVersion]
      properties:
        id: { type: string }
        title: { type: string }
        description: { type: string }
        seasonVersion: { type: string }
        metadata: { type: object }
    SceneState:
      type: object
      required: [id, episodeId, sceneOrder, sceneType, generatedPayload, resolved, resultFlags]
      properties:
        id: { type: string }
        episodeId: { type: string }
        sceneOrder: { type: integer }
        sceneType: { type: string }
        profile: { type: string }
        generatedPayload: { type: object }
        resolved: { type: boolean }
        resultFlags: { type: object }
    CampaignRun:
      type: object
      required: [id, campaignTemplateId, partyId, status, createdAt]
      properties:
        id: { type: string }
        campaignTemplateId: { type: string }
        partyId: { type: integer }
        status: { type: string }
        currentEpisodeId: { type: string }
        currentSceneId: { type: string }
        createdAt: { type: string, format: date-time }
        finishedAt: { type: string, format: date-time, nullable: true }
        currentScene:
          $ref: "#/components/schemas/SceneState"
    CampaignRunCreateRequest:
      type: object
      required: [campaignTemplateId, partyId]
      properties:
        campaignTemplateId: { type: string }
        partyId: { type: integer }
        characterIds:
          type: array
          items: { type: integer }
    CampaignActionRequest:
      type: object
      required: [actionType]
      properties:
        actionType: { type: string }
        payload: { type: object }
    CampaignSummaryResponse:
      type: object
      required: [adventureSummary, retconPackage]
      properties:
        adventureSummary: { type: object }
        retconPackage: { type: object }
