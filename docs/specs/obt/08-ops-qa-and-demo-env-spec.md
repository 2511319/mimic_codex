# RPG-Bot — Ops, QA и демонстрационное окружение  
## 08. Environments / Observability / QA / Playtests

## 1. Цель

Подготовить проект к позднему OBT с точки зрения:

- окружений (dev, stage, prod-demo),
- наблюдаемости (метрики, логи, traces),
- QA-плана и плейтестов.

## 2. Окружения

### 2.1. dev

- Используется разработчиками и CI.
- Характеристики:
  - может быть поднят локально;
  - допускается нестабильность данных.

### 2.2. stage

- Близко к prod-demo по конфигам:
  - схожие лимиты, включены ключевые сервисы;
- используется для:
  - финальной проверки релизов перед prod-demo;
  - интеграционных/нагрузочных тестов.

### 2.3. prod-demo

- Окружение для:
  - демонстраций,
  - первых тестовых волн игроков,
  - внутренних/ограниченных OBT-сессий.

### 2.4. Состав сервисов

Для stage и prod-demo обязательно:

- gateway_api
- party_sync
- media_broker + media-worker
- база данных (Postgres)
- Redis (party_sync + кеш/очереди)
- хранилище медиа-ассетов
- Retcon Engine
- Memory37/Graph (минимальная конфигурация, но рабочая)

## 3. Наблюдаемость

### 3.1. Метрики

Минимальный набор:

- по gateway_api:
  - latency и error-rate по ключевым endpoint’ам:
    - `/v1/auth/telegram`,
    - `/v1/campaign-runs/*`,
    - `/v1/campaign-runs/*/action`,
    - `/v1/campaign-runs/*/summary`.
- по party_sync:
  - количество активных WS-подключений;
  - число сообщений/сек;
  - число ошибок/разрывов.
- по Retcon Engine:
  - количество полученных RetconPackage;
  - продолжительность глобального тика.

### 3.2. Логи

- Единый формат логов (JSON, trace_id, request_id).  
- Логи gateway_api, party_sync, media_broker, Retcon Engine должны иметь общие поля для корреляции.

### 3.3. Traces

- OpenTelemetry-инструментация:
  - для входящих HTTP-запросов в gateway_api;
  - для ключевых вызовов к Memory37/Genlayers;
  - для глобального тика Retcon Engine.

## 4. QA-план

### 4.1. E2E-сценарии

Минимум два витринных сценария:

1. **Базовый “золотой путь”**:
   - новый игрок,
   - создание персонажа и партии,
   - запуск витринной кампании,
   - 4–6 сцен,
   - один боевой эпизод,
   - Adventure Summary без фатальных ошибок.

2. **Ветвящийся сценарий**:
   - выбор нетривиальных/“острых” решений,
   - проверка альтернативных сцен/эпилога,
   - проверка записи летописей и формирования RetconPackage.

### 4.2. Unit/интеграционные тесты

- Campaign Engine:
  - переходы сцен/эпизодов,
  - корректное применение флагов,
  - формирование Adventure Summary.

- Players/Characters/Parties:
  - создание/изменение/архивация персонажей,
  - присоединение к партиям.

- Retcon Engine:
  - приём RetconPackage,
  - базовая агрегация на глобальном тике.

### 4.3. Нагрузочные тесты

Для prod-demo:

- имитация N параллельных партий (например, 20–50) на одной кампании:
  - проверка устойчивости gateway_api и party_sync;
  - проверка времени ответов и error-rate.

## 5. Плейтесты

### 5.1. Внутренние плейтесты

- сценарий: сотрудники/узкий круг играют кампании на prod-demo;
- собирается feedback по:
  - стабильности,
  - UX,
  - качеству нарратива,
  - реакциям мира.

### 5.2. Логирование игрового поведения

- Логи и метрики L4 используются для:
  - корректировки баланса/сложности;
  - выявления “сломанных” узлов сюжета (слишком линейные, слишком смертельные и т.п.).

## 6. Definition of Done

- Разделены и документированы окружения dev / stage / prod-demo.  
- Поднята минимальная наблюдаемость (метрики, логи, базовые traces).  
- Реализованы и проходят ключевые e2e-тесты OBT-витринной кампании.  
- Проведены хотя бы несколько внутренних плейтестов, по результатам которых внесены правки в контент/баланс.
