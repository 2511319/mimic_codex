# RPG-Bot — Доведение до позднего ОБТ  
## 00. Общий обзор и волны работ

## 0. Цель документа

Этот документ задаёт целевое состояние проекта к моменту **позднего ОБТ** (далее — OBT) и описывает дорожную карту в виде волн работ и отдельных спецификаций.

Он нужен как:

- **мастер-навигатор** по всем ТЗ OBT;
- точка согласования между:
  - game design / narrative,
  - backend-командой,
  - UI-командой,
  - Codex/агентами.

## 1. Цели позднего ОБТ

К моменту позднего ОBT система должна обеспечивать:

1. **Полноценный цикл кампании**:
   - создание/выбор кампании (по шаблону);
   - прохождение приключения: сцены, проверки, боевые и социальные эпизоды;
   - финальный эпилог и итоги;
   - повторные прохождения с другими ветками.

2. **Многопользовательскую партию**:
   - несколько игроков в одной кампании;
   - корректный party-sync (join/leave/reconnect, голосование/решения, статусы);
   - отсутствие фатальных рассинхронов.

3. **Память мира и игроков**:
   - 5-слойная модель мира (L0–L4);
   - летописи персонажей и партий (immutable);
   - мир, который **капсулирован** во время прохождения приключения, но
     учитывает результаты множества run’ов через RetconPackage и глобальные тики.

4. **Лор и контент первого сезона**:
   - подключенный лор (государства, города, фракции, NPC, бестиарий, предметы);
   - как статические данные (канон), так и доступные для Memory37/Graph;
   - хотя бы одна витринная кампания, которой не стыдно показать внешний аудитории.

5. **Живой медиаслой (кроме TTS)**:
   - арты для ключевых сцен/локаций/NPC/монстров;
   - работающий media-пайплайн (pre-gen + runtime-обновление).

6. **Стабильное демонстрационное окружение**:
   - окружения dev / stage / prod-demo;
   - базовая наблюдаемость (метрики, логи, простые дашборды);
   - подготовленные e2e-сценарии и плейтесты.

**Вне OBT-скоупа:**

- TTS/voice-over и любые сложные VDM-слои;
- радикальные сезонные/эпохальные сдвиги канона (они строятся поверх уже собранной системы).

---

## 2. Архитектурный контекст

Проект строится вокруг существующих компонентов:

- `services/gateway_api` — BFF/API-шлюз для Telegram Mini-App;
- `services/party_sync` — сервис синхронизации партий;
- `services/media_broker` — медиаброкер и диспетчер задач медиа;
- `packages/memory37` и `memory37-graph` — память/граф/гибридный ретрив;
- `packages/genlayers` — слой генерации с профилями (Scene/Combat/Social/Epilogue);
- `packages/rpg_contracts` — OpenAPI/JSON Schema контракты.

OBT-работы **опираются на этот фундамент**, не перепридумывая его.

---

## 3. Волны работ и спецификации

Для удобства Codex/команд работы разбиты на волны.  
Каждая волна опирается на предыдущие и состоит из одной или нескольких спецификаций `.md`.

### Wave OBT-1 — Движок кампаний и модель игроков

**Фокус:** превратить набор эндпоинтов и генераций в целостный runtime-движок кампаний и стабильную модель игрока/персонажа/партии.

Спецификации:

1. `01-campaign-engine-spec.md`  
   — движок кампаний, L1 (симуляция кампании), Adventure Summary / RetconPackage.

2. `02-players-characters-parties-spec.md`  
   — модель игроков, персонажей, партий и летописей L2.

### Wave OBT-2 — Мир, память и реткон

**Фокус:** реализовать 5-слойную модель мира и Retcon Engine, который агрегирует результаты run’ов и глобально обновляет мету/канон.

Спецификация:

3. `03-world-and-retcon-spec.md`  
   — L0–L4, Chronicle, Influence Graph, RetconPackage ingestion, глобальные тики.

### Wave OBT-3 — Контент первого сезона

**Фокус:** сделать лор, бестиарий, предметы и кампании **первого сезона** частью рабочей системы через стабильный контент-пайплайн.

Спецификация:

4. `04-content-pipeline-season1-spec.md`  
   — формат контент-паков, CLI-импорт, версии Season 1.

### Wave OBT-4 — Реалтайм и медиаслой

**Фокус:** довести мультиплеер и медиапайплайн до уровня, достойного OBT.

Спецификации:

5. `05-realtime-and-party-sync-spec.md`  
   — party-sync, WS-протокол, интеграция с Campaign Engine.

6. `06-media-layer-spec.md`  
   — медиа без TTS: арты сцен, NPC, монстров, media_broker + воркеры.

### Wave OBT-5 — Контракты с UI, Ops, QA

**Фокус:** стабилизировать контракты с UI-командой и подготовить окружение/QA/плейтесты для реальных демонстраций.

Спецификации:

7. `07-gateway-and-ui-contracts-spec.md`  
   — финализация API/WS-контрактов под OBT-скоуп UI.

8. `08-ops-qa-and-demo-env-spec.md`  
   — окружения, наблюдаемость, QA-план и плейтесты.

---

## 4. Dependencies и порядок реализации

1. **Wave OBT-1** — обязательный фундамент.  
2. **Wave OBT-2** — строится поверх `01` и `02`.  
3. **Wave OBT-3** — опирается на движок кампаний и модель мира / Memory37.  
4. **Wave OBT-4** — требует Campaign Engine, Party/Players и базовый контент.  
5. **Wave OBT-5** — финальный слой интеграции и выведения в демонстрационный режим.

---

## 5. Definition of Done для позднего ОБТ

Проект считается доведённым до уровня позднего ОБТ, если:

1. Можно создать кампанию, пройти приключение, получить финальный отчёт и RetconPackage.  
2. Несколько игроков могут играть одну кампанию без критических рассинхронов.  
3. Мир имеет рабочие слои L0–L4, Retcon Engine обрабатывает пакеты и даёт метрики.  
4. Лор и контент Season 1 подключены через контент-пайплайн.  
5. Арт-слой и media-пайплайн функционируют в рамках OBT-скоупа.  
6. UI Mini-App работает на описанных API/WS-контрактах и покрывает OBT-экранный скоуп.  
7. Есть рабочее demo-окружение с базовой наблюдаемостью и e2e-тестами ключевой кампании.
