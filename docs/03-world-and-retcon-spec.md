# RPG-Bot — Мир, память и реткон  
## 03. World Layers (L0–L4), Retcon Engine, Global Ticks

## 1. Цель

Задать формальную модель мира и памяти:

- 5 слоёв L0–L4;
- Retcon Engine, который принимает `RetconPackage` после прохождения приключений;
- глобальные тики (раз в N дней) для обновления мета-уровня и кандидатов для канона.

## 2. Пять слоёв мира

### 2.1. L0 — Canon Core

- Канонический лор мира:
  - государства, регионы, города, фракции,
  - ключевые NPC, артефакты,
  - канонические исторические события.
- Изменяется:
  - только вручную (HITL) с помощью Retcon Engine;
  - версионируется (`world_version`: `S1-v0.1`, `S1-v0.2` и т.п.).

### 2.2. L1 — Campaign Simulation

- Объективное состояние мира **внутри конкретного CampaignRun**:
  - жив/мертв NPC в этой кампании,
  - состояние локаций,
  - прогресс сюжетных линий.
- Реализуется Campaign Engine (см. `01-campaign-engine-spec.md`).

### 2.3. L2 — Chronicles

- Иммутабельный лог событий по персонажам/партиям.
- Представлен `CharacterEvent` / `PartyEvent` (см. `02-*`).
- Служит источником правды о том, что игроки реально делали.

### 2.4. L3 — Perception & Memory

- Субъективное восприятие:
  - отношения NPC к персонажам/партий,
  - отношение фракций, городов,
  - ключевые “воспоминания” (несколько эпизодов, которые мир считает важными).
- Хранит **резюме**, а не все события.

### 2.5. L4 — Meta & Retcon Intelligence

- Метрики мира:
  - статистика решений по ключевым узлам;
  - судьбы важнейших NPC и фракций;
  - агрегированные показатели поведения игроков.
- Очередь кандидатов в изменения L0:
  - предложения патчей, основанные на тысячах run’ов.

## 3. WorldEvent и InfluenceGraph

### 3.1. WorldEvent

Базовый формат события, из которого строится летопись и реткон:

- `id`
- `campaign_run_id`
- `world_id`
- `actors` (список ссылок на `Character`/`Party`)
- `targets` (NPC/фракции/локации/предметы)
- `type` (enum: `KILL_NPC`, `SPARE_NPC`, `HELP_FACTION`, `DESTROY_LOCATION`, `SAVE_CITY`, др.)
- `importance` (`MICRO`, `MESO`, `MACRO`)
- `tags` (строковые теги: сюжетный узел, фракции, эпизод)
- `result` (успех/провал/частичный успех)
- `payload` (jsonb с деталями)
- `timestamp`

Для целей OBT WorldEvent — логическое надмножество `CharacterEvent`/`PartyEvent`.  
Удобно хранить либо в отдельной таблице, либо как представление.

### 3.2. InfluenceGraph

Представление влияния в виде графа:

- Узлы (`VNode`):
  - типы: `CHARACTER`, `PARTY`, `NPC`, `FACTION`, `CITY`, `LOCATION`, `ITEM`, `EVENT_CLUSTER`.
  - поля: `id`, `type`, `world_id`, `ref_id`.

- Рёбра (`VEdge`):
  - `from_node_id`, `to_node_id`
  - `relation_type` (enum: `HELPED`, `BETRAYED`, `KILLED`, `SAVED`, `SUPPORTED`, `OPPOSED`, др.)
  - `weight` (float)
  - `sign` (`POSITIVE`, `NEGATIVE`, `NEUTRAL`)
  - `last_event_at`
  - `decay_params` (как быстро “забывается”)

Эти структуры желательно хранить в Graph-БД (использовать `memory37-graph`) или в таблицах с возможностью индексированных запросов.

## 4. RetconPackage ingestion

Retcon Engine принимает `RetconPackage`, сформированный Campaign Engine:

- `RetconPackage`:
  - `world_id`
  - `campaign_template_id`
  - `campaign_run_id`
  - `season_version`
  - `world_deltas` (структурированные изменения по NPC/фракциям/локациям в рамках run’а)
  - `player_impact`
  - `meta_stats`

Retcon Engine:

1. Записывает пакет в хранилище (для аудита).
2. Извлекает из него WorldEvent-подобные записи (если нужны).
3. Обновляет локальную статистику, которая будет потом учтена на глобальном тике.

## 5. Глобальный тик мира (Global World Tick)

### 5.1. Периодичность

- Конфигурируемый интервал (по умолчанию **раз в 3 дня** реального времени).
- Запускается:
  - через cron,
  - либо через внешний orchestrator.

### 5.2. Алгоритм

1. Забрать все `RetconPackage` за период `[last_tick; now)`.
2. Агрегировать:

   - по NPC:
     - сколько раз погиб/выжил/был изгнан/сменил сторону;
   - по фракциям/городам:
     - сколько раз побеждали/проигрывали;
   - по ключевым сюжетным узлам:
     - распределение выборов (вариант A/B/C, проценты);
   - по игрокам:
     - поведенческие метрики (жестокость/милосердие, предательство/честь и т.п.).

3. Обновить:

   - InfluenceGraph (L3):
     - веса рёбер;
     - агрегаты восприятия (отношения фракций и NPC).
   - world_meta (L4):
     - долгосрочные тенденции;
     - “настроение мира”.

4. Сгенерировать кандидатов в изменения канона L0:

   - примеры:
     - “NPC X в 85% кампаний погибает как мученик в битве Y”;
     - “город Z почти всегда сгорает”;
     - “фракция W в 70% случаев проигрывает”.

5. Сохранить `GlobalMetaSnapshot`:

   - `world_id`, `timestamp`, агрегированные метрики, список кандидатов.

## 6. HITL и патчи канона (L0)

Retcon Engine должен предоставлять интерфейс (CLI/API) для редакторов:

- `GET /v1/world/canon-candidates`  
  — список кандидатов на изменение канона, с метриками.

- `POST /v1/world/canon-patches`  
  — принятие/отклонение предложений, формирование патчей L0.

Патч L0:

- `target` (NPC/фракция/город/событие),
- `change` (описание изменения),
- `reason` (на основе каких метрик принято решение),
- `applied_by`,
- `applied_at`,
- `new_world_version`.

После применения патча:

- обновляется канон (источники в контент-паках — см. `04-content-pipeline-season1-spec.md`);
- запускается re-ingest в Memory37 для соответствующих сущностей.

## 7. Perception & Memory (L3) — требования к агрегатам

На уровне L3 для каждой важной сущности (NPC/фракции/города) храним:

- **ограниченный набор связей с игроками/партий** (top-N по влиянию);
- агрегированные показатели:
  - `trust`, `fear`, `hatred`, `respect`, `gratitude` и т.п.;
- несколько “якорных эпизодов”, которые будут подаваться в генерацию как память.

Retcon Engine отвечает за периодическое обновление этих агрегатов на глобальных тиках.

## 8. Интеграция с Memory37

Memory37 должен иметь отдельные домены:

- `lore_canon` (L0),
- `campaign_state` (snapshot’ы из L1, если нужно для ретроспектив),
- `chronicles_summaries` (агрегированные L2),
- `world_perception` (L3),
- `world_meta` (L4).

NarrativeOrchestrator (из Campaign Engine) при сборе контекста обращается к Memory37 за:

- канон+локальный контекст,
- perception/отношения,
- по возможности — meta-тенденциями (как soft-bias).

## 9. Definition of Done

- Реализованы модели и таблицы для RetconPackage, WorldEvent, InfluenceGraph, GlobalMetaSnapshot.  
- Реализован сервис/модуль Retcon Engine с описанными endpoint’ами.  
- Глобальный тик мира агрегирует `RetconPackage` и обновляет L3/L4.  
- Есть механизм формирования кандидатов в патчи L0 и интерфейс для их ручного применения.  
- Добавлены тесты агрегации и базового сценария: несколько run’ов → один глобальный тик → корректные метрики.
