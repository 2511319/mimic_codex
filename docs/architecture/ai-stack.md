# AI‑стек и память: OpenAI + pgvector

Документ описывает целевую архитектуру генерации и памяти с учётом выбранных технологий: OpenAI как провайдер ИИ и PostgreSQL + pgvector как хранилище знаний.

## Потоки данных

1) WebApp → Gateway API (REST)
   - Авторизация initData → JWT. Дальнейшие вызовы с Bearer токеном.

2) Генерация (genlayers)
   - Профили (profiles) задают температуру, токены, схему structured outputs.
   - Вызовы к OpenAI (chat/completions, responses), валидация ответа по JSON Schema.
   - Лёгкий оркестратор промптов, декомпозиция на сцены/подзадачи.

3) Память (memory37)
   - Хранение доменов знаний (knowledge: srd, lore, эпизоды кампаний) в PostgreSQL + pgvector.
   - ETL индексации (разбор источников → embeddings → запись в индекс). Провайдер embeddings — OpenAI.
   - Гибридный поиск (vector + keyword), агрегация результатов.

4) Media Broker
   - Постановка TTS/IMG/Avatar задач; менеджер очереди; опционально кэш CDN.

## Абстракции и плагины

- Провайдеры LLM/Embeddings/TTS/IMG — через SPI (интерфейсы и фабрики), выбор реализаций конфигурацией.
- Провайдеры Storage — адаптеры для PostgreSQL/pgvector (прямой драйвер или ORM), расширяемо под другие движки.

## OpenAI: практики

- Structured outputs: жёсткая схема JSON ответа, пост‑валидация и ретраи с узкими подсказками.
- Ограничение стоимости: batch, reuse контекста, короткие подсказки, кэширование результатов.
- Надёжность: ретраи с экспоненциальной задержкой, таймауты, circuit‑breaker, логирование токенов и ошибок.

## PostgreSQL + pgvector: практики

- Схема: таблицы документов/фрагментов, вектора, метаданные (source, tags, lang, timestamps).
- Индексы: ivfflat/hnsw (зависит от версии), настройки maintenance_work_mem, анализ статистики.
- Миграции: управляются отдельно на уровне сервиса, отвечающего за ETL.

## Наблюдаемость и стоимость

- Метрики: счётчики токенов (prompt/response), latency к OpenAI, hit‑ratio кэша, RPS генераций.
- Стоимость: отчёт по доменам/фичам, лимиты на пользователя/сессию.

