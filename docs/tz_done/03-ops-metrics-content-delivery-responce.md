---

# 03-ux-states-retcon-guide.md

**Версия:** 1.0 (2025-10-31)
**Владельцы:** UX Lead, Геймдизайн, Редакторы/GM, Разработка (Mini App)
**Объём поставки:** пользовательские тексты/состояния для всех ключевых экранов Mini App + прикладной гайд по ретконам

---

## 0) Нормативные базовые линии (2025)

* **Telegram Mini Apps:** используем нативные `MainButton`, `BackButton`, `Popup`, `HapticFeedback` и `openInvoice` для платёжных сценариев. Это повышает консистентность и надёжность в контейнере Telegram. ([Telegram][1])
* **Доступность (WCAG 2.2 AA):** кликабельные мишени не меньше **24×24 CSS px** (или эквивалентные интервалы), без горизонтального скролла при ширине **320 px** (reflow). ([W3C][2])
* **Микро-уведомления (snackbar/toast):** 1–2 строки, действия — максимум одно, располагаем внизу и не перекрываем критичный UI. ([Material Design][3])
* **Сетевые повторные подключения:** **экспоненциальный backoff с jitter** (cap по времени), чтобы не создавать пульсаций нагрузки. ([Amazon Web Services, Inc.][4])
* **Прозрачность ИИ и защита контента:** стандарт **C2PA/Content Credentials** (Content Authenticity Initiative) + **IPTC/XMP**-метаданные; для фазы 2 — невидимые водяные знаки (DCT/DWT) как дополнительный слой. ([c2pa.org][5])

---

## 1) Принципы текста и стиля

* **Обращение:** «**ты**» (дружелюбно, прямые глаголы).
* **Длины (мобильный первично):**

  * заголовки ≤ 48 симв.;
  * плейсхолдеры ≤ 40;
  * CTA ≤ 24;
  * тосты/снекбары — 1–2 строки (≈ до 80 симв.), авто-скрытие 4–8 с. ([Material Design][3])
* **Эмодзи:** точечно для статусов (успех/внимание/инфо), без перегруза.
* **Доступность:** мишени ≥24×24 px; reflow 320 px; тост не перехватывает фокус и не блокирует основное действие. ([W3C][2])

---

## 2) Карта ключевых экранов и модель состояний

Каждый экран описан через типовые состояния: **Loading / Ready / Empty / Error / Unauthorized / Reconnect**. Мы **не поддерживаем оффлайн-очереди**, поэтому при потере сети показываем чёткие инструкции по восстановлению соединения; короткие «микро-па́узы» нивелируем авто-повтором + backoff+jitter. ([Amazon Web Services, Inc.][6])

> Легенда таблиц:
> **UI-текст** — готовая строка «как есть»; **CTA** — первичное/вторичное действие; **Система** — системные эффекты (хаптик, тост); **Примечания** — ограничения и деградации.

### 2.1 Auth / Init

| Состояние    | UI-текст                                           | CTA           | Система                           | Примечания                          |
| ------------ | -------------------------------------------------- | ------------- | --------------------------------- | ----------------------------------- |
| Loading      | «Проверяем данные запуска…»                        | —             | скелетон 0.6–3 c; >3 c — прогресс | initData, проверка сигнатуры        |
| Unauthorized | «Нет доступа. Открой Mini App из чата Telegram.»   | «Открыть чат» | haptic `warning`                  | показ через `openTelegramLink`      |
| Error        | «Не удалось подтвердить запуск. Попробуй ещё раз.» | «Повторить»   | тост «Сбой инициализации»         | покажи `Подробнее` → Correlation ID |
| Ready        | «Готово»                                           | «Продолжить»  | haptic `impact`                   | —                                   |

### 2.2 Домашний экран / Кампания

| Состояние | UI-текст                                       | CTA                | Система                           | Примечания                             |
| --------- | ---------------------------------------------- | ------------------ | --------------------------------- | -------------------------------------- |
| Empty     | «У тебя ещё нет кампаний. Создай первую.»      | «Создать кампанию» | —                                 | empty-иллюстрация + короткая подсказка |
| Ready     | «Выбери кампанию»                              | «Открыть»          | —                                 | список кампаний, поиск                 |
| Error     | «Не вышло загрузить кампании. Попробуй снова.» | «Повторить»        | тост «Ошибка загрузки»            | —                                      |
| Reconnect | «Связь потеряна. Пытаемся подключиться…»       | «Повторить»        | линейный спиннер + backoff+jitter | без оффлайн-черновиков                 |

### 2.3 Сцена (Story) / Ветка выбора

| Состояние | UI-текст                                  | CTA          | Система               | Примечания                                    |
| --------- | ----------------------------------------- | ------------ | --------------------- | --------------------------------------------- |
| Loading   | «Готовим сцену…»                          | «Отменить»   | скелетон текста       | >3 c — подсказка «Это займёт немного времени» |
| Ready     | заголовок + 2–4 абзаца; варианты (до 3)   | «Выбрать N»  | haptic `selection`    | `choices[].label` ≤ 24 симв.                  |
| Empty     | «Здесь пока пусто. Создай первую сцену.»  | «В редактор» | —                     | —                                             |
| Error     | «Не вышло сгенерировать сцену. Повторим?» | «Повторить»  | тост «Сбой генерации» | —                                             |
| Reconnect | «Пытаемся восстановить соединение…»       | «Повторить»  | backoff+jitter        | —                                             |

### 2.4 Бой (Combat)

| Состояние | UI-текст                       | CTA                           | Система                   | Примечания                       |
| --------- | ------------------------------ | ----------------------------- | ------------------------- | -------------------------------- |
| Ready     | «Ход №{n}. Твоя цель — …»      | «Атака», «Защита», «Предметы» | тактильная обратная связь | упрощённый HUD, портрет/ландшафт |
| Error     | «Сбой расчёта боя. Повторить?» | «Повторить»                   | тост                      | —                                |
| Reconnect | «Ожидаем связь…»               | «Повторить»                   | backoff                   | «резервация» хода на сервере     |

### 2.5 Лут / Инвентарь

| Состояние | UI-текст                                 | CTA                        | Система | Примечания          |
| --------- | ---------------------------------------- | -------------------------- | ------- | ------------------- |
| Empty     | «Пока пусто. Добудь лут в приключениях.» | «К приключениям»           | —       | —                   |
| Ready     | «Твои предметы»                          | «Использовать», «Сравнить» | —       | карточки 1–2 строки |

### 2.6 Поиск по лору (Knowledge Search)

| Состояние   | UI-текст                                              | CTA         | Система | Примечания |
| ----------- | ----------------------------------------------------- | ----------- | ------- | ---------- |
| Placeholder | «Поиск по лору, NPC, локациям…»                       | —           | —       | —          |
| No results  | «Ничего не найдено. Попробуй другой запрос или теги.» | «Очистить»  | —       | —          |
| Error       | «Сервис поиска недоступен. Повтори позже.»            | «Повторить» | тост    | —          |

### 2.7 Медиа-задачи (IMG/TTS)

| Состояние | UI-текст                               | CTA         | Система             | Примечания                                     |
| --------- | -------------------------------------- | ----------- | ------------------- | ---------------------------------------------- |
| Loading   | «Генерируем медиа…»                    | «Отменить»  | прогресс            | текст сцены — **сразу**, медиа — по готовности |
| Success   | «Готово! Открываем результат.»         | «Открыть»   | тост «Медиа готово» | превью + иконка «ИИ»                           |
| Error     | «Не удалось получить медиа. Повторим?» | «Повторить» | тост                | 2 ретрая с backoff                             |

> Показ медиа «по кнопке»; текст сцены не блокируется медиа-генерацией (бережём UX и трафик). ([Material Design][3])

### 2.8 Party-синхронизация (WS)

| Состояние     | UI-текст                                 | CTA         | Система            | Примечания                                 |
| ------------- | ---------------------------------------- | ----------- | ------------------ | ------------------------------------------ |
| Connected     | «Онлайн»                                 | —           | зелёный маркер     | —                                          |
| Disconnected  | «Связь потеряна. Пытаемся подключиться…» | «Повторить» | линейный индикатор | backoff+jitter                             |
| Update banner | «Сцена обновлена мастером»               | «Обновить»  | haptic `warning`   | блокирующий баннер пока не синхронизирован |

---

## 3) Словарь строк `strings.ru-RU.json` (выдержка)

> Формат — плоские ключи; плурали/форматы дат — через ICU при необходимости. Длины — как в принципах выше. WCAG/Material соблюдены. ([W3C][2])

```json
{
  "app.status.loading": "Загружаем…",
  "app.status.ready": "Готово",
  "nav.home": "Главная",
  "nav.campaigns": "Кампании",
  "nav.inventory": "Инвентарь",
  "nav.settings": "Настройки",

  "auth.loading": "Проверяем данные запуска…",
  "auth.unauthorized.title": "Нет доступа",
  "auth.unauthorized.body": "Открой Mini App из чата Telegram.",
  "auth.error.title": "Не удалось подтвердить запуск",
  "auth.error.cta": "Повторить",
  "auth.ready.cta": "Продолжить",

  "campaigns.empty.title": "У тебя ещё нет кампаний",
  "campaigns.empty.body": "Создай первую кампанию и начни приключение.",
  "campaigns.empty.cta": "Создать кампанию",
  "campaigns.list.title": "Выбери кампанию",
  "campaigns.error": "Не вышло загрузить кампании. Попробуй снова.",

  "scene.loading": "Готовим сцену…",
  "scene.empty.title": "Здесь пока пусто",
  "scene.empty.body": "Создай первую сцену в редакторе.",
  "scene.error": "Не вышло сгенерировать сцену. Повторим?",
  "scene.choice.more": "Ещё",

  "choices.pick": "Выбрать",
  "choices.alt": "Другой вариант",

  "combat.turn": "Ход №{n}",
  "combat.error": "Сбой расчёта боя. Повторить?",
  "combat.cta.attack": "Атака",
  "combat.cta.defend": "Защита",
  "combat.cta.items": "Предметы",

  "loot.empty.title": "Пока пусто",
  "loot.empty.body": "Добудь лут в приключениях.",
  "loot.title": "Твои предметы",
  "loot.cta.use": "Использовать",
  "loot.cta.compare": "Сравнить",

  "search.placeholder": "Поиск по лору, NPC, локациям…",
  "search.no_results": "Ничего не найдено. Попробуй другой запрос или теги.",
  "search.error": "Сервис поиска недоступен. Повтори позже.",

  "media.loading": "Генерируем медиа…",
  "media.done.toast": "Медиа готово",
  "media.error": "Не удалось получить медиа. Повторим?",
  "media.cta.open": "Открыть",

  "ws.status.connected": "Онлайн",
  "ws.status.connecting": "Пытаемся подключиться…",
  "ws.status.disconnected": "Связь потеряна. Пытаемся подключиться…",

  "retcon.banner": "Сцена обновлена ретконом",
  "retcon.cta.view_diff": "Показать изменения",
  "retcon.cta.apply": "Применить",
  "retcon.cta.cancel": "Отмена",
  "retcon.toast.applied": "Откат выполнен",
  "retcon.toast.rejected": "Откат отклонён",

  "errors.common_retry": "Что-то пошло не так. Попробуй ещё раз.",
  "errors.network": "Не получается подключиться. Проверь интернет.",
  "errors.init": "Сбой инициализации. Повтори попытку.",
  "errors.details": "Подробнее",
  "errors.correlation_id": "Код ошибки: {id}",

  "payments.info": "Оплата — за доп. сервисы и доступы. На баланс/сюжет не влияет.",
  "payments.cta.subscribe": "Оформить доступ",
  "payments.toast.success": "Оплата прошла успешно",
  "payments.toast.fail": "Оплата не удалась. Попробуй ещё раз.",

  "badges.ai": "ИИ",
  "labels.generated_by_ai": "Сгенерировано ИИ"
}
```

---

## 4) «Состояния по экранам» (короткий справочник для разработчиков/QA)

> **Паттерн загрузки:** ≤600 мс — «ничего/микро-скелет», 0.6–3 с — skeleton, >3 с — прогресс + «что происходит» (снижает ощущаемое ожидание). ([Material Design][3])

* **Auth/Init:** `Loading → (Unauthorized|Error) → Ready`
* **Кампании:** `Loading → (Empty|Ready|Error)`
* **Сцена:** `Loading → (Ready|Empty|Error)`; `Reconnect` поверх при отвале WS
* **Бой:** `Ready|Error|Reconnect`
* **Инвентарь/Лут:** `Empty|Ready|Error`
* **Поиск:** `Placeholder|Results|NoResults|Error`
* **Медиа:** `Loading|Success|Error` (текст — сразу, медиа — позже)
* **Party/WS:** `Connected|Connecting|Disconnected` (UI-баннеры, автоповтор с jitter) ([Amazon Web Services, Inc.][6])

**DoD (готовность):** охвачены все состояния, нет тупиков; CTA не длиннее 24 симв.; кликабельные зоны ≥24×24 px; reflow 320 px проходит; тосты 1–2 строки; WS-переподключение с jitter; Problem+JSON + correlationId на стороне API. ([W3C][2])

---

## 5) Retcon-Guide (для редакторов/GM)

### 5.1 Политика

* **Глубина:** мягкий реткон **на 1 шаг** (последняя сцена/ход/выбор).
* **Монетизация:** у нас **здоровая экономика** — платные сервисы/доступы **не** меняют баланс/сюжет, поэтому реткон **разрешён** даже после платного действия. Финансовые транзакции не «откатываются» ретконом, но нарратив — да (при необходимости показываем нотис «Оплата не затронута»).
* **Прозрачность:** каждый реткон требует **причину** (короткая метка + категория: «лор», «тех», «этика/контент»).
* **Аудит:** append-only журнал (время, автор, причина, дифф), идентификатор корреляции совпадает с логами/трассировкой — для саппорта. (Рекомендуем Problem+JSON + `correlationId` в HTTP-ответах.) ([Amazon Web Services, Inc.][6])

### 5.2 Роли и ответственность

* **GM:** инициирует реткон; формулирует причину; валидирует отсутствие влияния на платёжные состояния (только контент).
* **Редактор:** приводит текст к гайдлайнам (тон «ты», длины, допустимые эмодзи); следит за непротиворечивостью лора.
* **Система:** пересобирает сцену и уведомляет партию баннером «Сцена обновлена ретконом».

### 5.3 UX потоки (клиент)

1. **Инициировать реткон:** GM → «Откатить последний шаг» → Popup-подтверждение «Откатить?» → текстовое поле «Причина (до 80 симв.)» → `Применить`.
2. **Отобразить изменения:** баннер «Сцена обновлена ретконом» → CTA «Показать изменения» → компактный дифф (± 3 фразы).
3. **Конфликт:** если другой редактор/GM внёс изменения, показываем «Не удалось применить реткон — есть новые правки» → CTA «Открыть историю».

### 5.4 Типовые кейсы «до/после»

* **Неверная схема JSON**

  * До: «label» 40+ симв., >3 варианта выбора
  * После: label ≤ 24, максимум 3 варианта; валидный `SceneResponse`
* **Противоречие лору**

  * До: «Город А у моря» (в лоре — в горах)
  * После: «Город А у подножия гор; порт — в соседней долине» (сохраняем драматургию, избегаем новых фактов)
* **Нежелательный тон**

  * До: пассивные формулировки
  * После: активные глаголы, «ты», короткие предложения
* **Слишком длинная сцена**

  * До: 7+ абзацев
  * После: 2–4 абзаца, вынесены детали в «Ещё»
* **Некорректная кнопка**

  * До: «Персонаж делает…»
  * После: «Атаковать», «Отступить», «Говорить»

### 5.5 Тексты подтверждений/ошибок (готовые)

* **Popup реткона:**

  * Заголовок: «Откатить на один шаг?»
  * Текст: «Реткон изменит последнюю сцену/ход. Оплаты не затронем.»
  * Поле: «Причина (до 80 символов)»
  * Кнопки: «Применить» / «Отмена»
* **Успех:** «Откат выполнен»
* **Отклонено:** «Не удалось применить реткон — есть новые правки»
* **Баннер партии:** «Сцена обновлена ретконом» → «Показать изменения»

---

## 6) Платежи и тексты

* **Принцип:** платим за **доп.сервисы/доступы**, **не** за влияние на баланс/сюжет.
* **UI-паттерн:** открываем инвойс системным методом, ловим `paid`-колбэк, сразу даём тост «Оплата прошла» и обновляем доступы. ([Telegram][1])
* **Строки:** см. `payments.*` в словаре; добавляем инфо-блок «На баланс/сюжет не влияет».

---

## 7) Сетевые состояния и устойчивость

* **WS reconnect:** экспоненциальный backoff (например, 1s → 2s → 4s … cap 30s) + **jitter ±20%**; линейный индикатор «Пытаемся подключиться…»; кнопка «Повторить». ([Amazon Web Services, Inc.][4])
* **HTTP retry:** 2 попытки с тем же паттерном; не повторяем небезопасные запросы (идемпотентность).
* **Нет оффлайн-очереди:** при отсутствии сети показываем «Не получается подключиться. Проверь интернет» + «Повторить»; пользовательский прогресс сохраняется на сервере, поэтому рисков «расхождения» нет.

---

## 8) Маркировка синтетики и защита контента (план внедрения)

> Цель — дать игрокам явный индикатор ИИ-происхождения и защищать за пределами платформы.

* **Фаза 1 (сейчас):**

  * Значок **«ИИ»** на карточках медиа; подпись «Сгенерировано ИИ».
  * При выгрузке изображений/аудио из Mini App — встраивать **Content Credentials (C2PA)** + базовые **IPTC/XMP**-поля: `DigitalSourceType=Composite Synthetic`, `GeneratedByAI=true`, инструмент, дата/время, автор/бот. ([c2pa.org][5])
* **Фаза 2 (после релиза ядра):**

  * **Невидимые водяные знаки** (DWT/DCT-класса) + устойчивость к ресейвам/скринам; документировать устойчивость/ложноположительные. ([arXiv][7])
  * Интеграция с **NFT-модулем**: связывание хэша ассета (CID) с объектом владения; проверка целостности при обмене/торговле.

---

## 9) Реализация в Mini App (шпаргалка)

* **Кнопки/хаптик:** `WebApp.MainButton`, `WebApp.BackButton`, `HapticFeedback.impactNotification()` — успех/предупреждение/ошибка. ([Telegram][1])
* **Платежи:** `WebApp.openInvoice()` → обработка `invoiceClosed/paid`. ([Telegram][1])
* **Навигация:** `BackButton.show()` на вложенных экранах; `MainButton` — контекстная CTA.
* **Тосты/снекбары:** 1–2 строки, внизу, без блокировки основного действия. ([Material Design][3])
* **Доступность:** размеры мишеней ≥24×24 px; reflow 320 px. ([W3C][2])

---

## 10) QA-чек-лист (приёмка)

* [ ] Все экраны имеют **Loading/Ready/Empty/Error/Unauthorized/Reconnect**.
* [ ] CTA ≤ 24 симв.; плейсхолдеры ≤ 40; тосты: 1–2 строки. ([Material Design][3])
* [ ] Кликабельные зоны ≥24×24 px; reflow 320 px без горизонтальной прокрутки. ([W3C][2])
* [ ] WS-переподключение: backoff+jitter; сообщения статуса видны. ([Amazon Web Services, Inc.][6])
* [ ] Ошибки API возвращаются в формате Problem+JSON c `correlationId`; в UI есть «Подробнее».
* [ ] Медиа: текст — сразу, медиа — по готовности; 2 ретрая с backoff; значок «ИИ».
* [ ] Реткон ≤ 1 шаг, причина обязательна, история видна, партия уведомлена баннером.
* [ ] Платежи: оплата не влияет на баланс/сюжет; при ретконе отображается нотис «Оплата не затронута».

---

## 11) Приложение A — Шаблон «states.md» для команды

```md
# states.md (шаблон на экран)

## <Экран>
### Loading
- UI: "<...>"
- Система: skeleton/progress
- Таймауты: >3 c — подсказка

### Ready
- UI: "<...>"
- CTA-primary: "<...>"
- CTA-secondary: "<...>"

### Empty
- UI: "<что за экран> + 1–2 шага"
- CTA: "<создать/начать>"

### Error
- UI: "Что случилось + что делать"
- CTA: "Повторить"
- Подробнее: correlationId (сверка с логами)

### Unauthorized
- UI: "Нет доступа. Открой Mini App из чата Telegram."
- CTA: "Открыть чат"

### Reconnect
- UI: "Связь потеряна. Пытаемся подключиться…"
- Сеть: backoff+jitter (cap 30 c), кнопка "Повторить"
```

---

## 12) Приложение B — Шаблон записи реткона (аудит)

```json
{
  "retconId": "rc_2025-10-31T12:34:56Z_8f3a",
  "campaignId": "cmp_...",
  "sceneId_before": "sc_123",
  "sceneId_after": "sc_124",
  "author": { "id": "gm_42", "role": "GM" },
  "reason": { "label": "Лор", "comment": "Город не у моря, а в горах" },
  "correlationId": "corr-7e2b...",
  "diff": { "summary": "Правка географии; без влияния на выборы", "size": "small" },
  "appliedAt": "2025-10-31T12:34:56Z"
}
```

