# Глава 7 — Методология агентной разработки (Codex + GPT-5)

Эта глава — «плейбук» для ИИ-разработчика (Codex на GPT-5) и человека-куратора. Она определяет порядок работ, правила, контрольные точки и артефакты так, чтобы агент шаг-за-шагом собрал продукт, не теряя контекст и не противореча Главам 1–6, 8–10.  
Везде ниже даны: **Что делаем → Зачем → Как проверить**. Оптимальные решения (выбранные ранее) встроены как нормы.

## 7.0 Принципы и «рамка»

1.  **Contracts-first**: сначала схемы/контракты, потом код.  
    Зачем: единый «источник истины», автоген SDK, контракт-тесты.  
    Проверка: есть валидный OpenAPI 3.1 + JSON Schema, линт пройден, SDK сгенерирован.
2.  **Memory-aware**: любая генерация опирается на «Память37» (Гл.8).  
    Зачем: консистентный лор/SRD/эпизоды/NPC, отсутствие дрейфа тона.  
    Проверка: в трассах видно вызовы ретрива (BM25+вектор), в промпте — топ-N чанков.
3.  **Structured outputs**: ответы LLM — **строгий JSON** по схемам (Гл.9).  
    Зачем: без крохких парсеров, предсказуемость UI и логики.  
    Проверка: респонсы проходят strict-валидацию; при сбое — авто-ремонт мини-перезапросом.
4.  **Идемпотентность и события**: все write-операции с Idempotency-Key; доменная шина — CloudEvents.  
    Зачем: безопасные ретраи/повторы, сквозная корреляция.  
    Проверка: повторный POST с тем же ключом возвращает идентичный результат; в событиях есть trace_id.
5.  **Trunk-based + QA-пирамида + автоматические релизы**.  
    Зачем: быстрая поставка, меньше merge-ада, воспроизводимые релизы.  
    Проверка: короткие ветки, semantic-release, зелёные линт/тесты, CHANGELOG обновляется.
6.  **Secure & Observable by design** (Гл.6): Telegram initData → серверная валидация → короткий JWT; Trace Context + OpenTelemetry; SLO/алерты; 429 + Retry-After.  
    Зачем: предсказуемая эксплуатация, низкий MTTR.  
    Проверка: интеграционные тесты auth; дашборды p95; алерты по error-budget.

## 7.1 Роли и взаимодействия

- **Человек-куратор (HITL)**: утверждает контракты, проводит CR критичных PR, принимает релизы, решает спорные вопросы лора/тона.
- **Агенты Codex (GPT-5)**:
    - **Planner**: дробит эпик на шаги (≤ 600 строк контекста на задачу), формирует DoR/выходные артефакты.
    - **Spec Writer**: пишет OpenAPI/JSON Schema/CloudEvents, Spectral-линт, примеры (goldens).
    - **Coder**: код по контрактам (минимальные диффы, чистые интерфейсы).
    - **Reviewer**: self-check чек-листы (безопасность, идемпотентность, трассы).
    - **Tester**: генерирует юнит/контрактные/интеграционные/минимальные E2E.
    - **Releaser**: semantic-release, SBOM, vuln-скан, Blue-Green/Canary сценарии.

**Зачем**: разделение компетенций снижает путаницу и когнитивную нагрузку ИИ.  
**Проверка**: в PR-шаблоне заполнены секции Planner/Spec/Coder/Tester; воркфлоу «зелёный».

## 7.2 Каркас репозитория (монорепо)

/contracts/ # OpenAPI 3.1, JSON Schema, CloudEvents + examples + spectral.yaml

/packages/

@rpg-contracts/ # автоген SDK + типы (TS/Python)

/apps/

webapp/ # Telegram Mini App (client)

/services/

gateway-api/ # BFF, auth (initData->JWT), rate-limits

narrative-engine/ # сцены/правила/броски; интеграция с Память37/ген-слоями

party-sync/ # таймеры, пати, SSE/WebSocket

media-broker/ # очереди TTS/ASR/IMG/Avatar, кэш, CDN signed URLs

billing-usage/ # юниты/лимиты/usage

/packages/

memory37/ # адаптеры хранилищ, ретрив, политики

genlayers/ # профили промптов, structured outputs, tools/MCP

observability/ # обёртки OTel, трасс-middleware

security/ # валидаторы initData/JWT, HMAC-вебхуки

/docs/

ADRs/ # архитектурные решения

.github/ # CI/CD, шаблоны PR/ISSUE

/deploy/ # IaC/compose, pipelines, миграции

**Зачем**: стабильные границы, переиспользование контрактов/библиотек, единые инструменты.  
**Проверка**: импорт SDK только из @rpg-contracts; сервисы не «лезут» в чужие БД напрямую.

## 7.3 Последовательность работ (WBS «вертикальный срез»)

**Шаг 0 — Bootstrap (1–2 дня).**  
Что: моно-репо, базовые конфиги (pre-commit, Ruff/ESLint, Spectral), CI ci.yml, OTel-инструментация, .env.example, SOPS.  
Зачем: общая операционная «почва», ранний фидбек.  
Проверка: коммит «bootstrap» проходит CI end-to-end.

**Шаг 1 — Контракты (Contracts-first).**  
Что: /contracts/openapi.yaml (v1), JSON Schema моделей, CloudEvents типы, примеры (goldens), Spectral линт, автоген SDK.  
Зачем: «источник истины», фронт/бэк/агенты синхронизируются.  
Проверка: make contracts:validate && make sdk:gen зелёные; Pact/bi-directional (минимум критичные пути).

**Шаг 2 — Narrative-engine (core loop).**  
Что: API презентера сцен, применение правил/бросков (Гл.3), интеграция Memory37/Genlayers (Гл.8/9), JSON structured outputs.  
Зачем: минимально играбельная соло-петля.  
Проверка: юнит-тесты эффектов/бросков; контракт-тесты респонсов по схемам; E2E «соло-ветка».

**Шаг 3 — Party-sync (мультиплеер).**  
Что: лобби, голосование, таймеры, SSE push; CloudEvents для ключевых стадий.  
Зачем: пати-режим с синхронизацией.  
Проверка: интеграционные тесты таймеров/голосования; имитация реконектов.

**Шаг 4 — Media-broker.**  
Что: TTS/ASR/IMG/Avatar очереди, кэш по хэшу запроса, CDN signed URLs, модерация.  
Зачем: мультимедиа без взрывов бюджета.  
Проверка: «золотые» задания → 202→done events; DLQ-алерты; p95 цели (Гл.5/6).

**Шаг 5 — Billing-usage.**  
Что: юниты/лимиты, учёт затрат, интеграция Telegram Payments/Stars.  
Зачем: монетизация и контроль расходов.  
Проверка: контракт-тесты на списания/рефанды; идемпотентность операций.

**Шаг 6 — Webapp UX.**  
Что: Mini App экраны (Главное, Сцена, Бой, Лобби, Редактор), состояния загрузки/ошибок, локализация, доступность.  
Зачем: завершить вертикальный срез.  
Проверка: визуальные снепшоты, ручные сценарии, Lighthouse-порог.

**Шаг 7 — QA/Нагрузка/Релиз.**  
Что: пирамида тестов; профили нагрузки для очередей; Blue-Green на stage→prod, canary (LLM-шаблоны).  
Зачем: безопасно выпустить.  
Проверка: чек-листы DoR/DoD, алерты на error-budget, Post-release мониторинг.

## 7.4 Нормы (стандарты, «не обсуждается»)

- **API**: OpenAPI 3.1 + JSON Schema; **линт** — Spectral; **пагинация** — cursor; **PATCH** — JSON Merge Patch; **ошибки** — единый JSON, 429 + Retry-After; **идемпотентность** — Idempotency-Key (TTL 24–72ч).
- **Events**: CloudEvents 1.0.x JSON; порядок внутри ключей (partition key = campaign_id/party_id); at-least-once + DLQ.
- **Observability**: W3C Trace Context; OpenTelemetry (traces/metrics/logs) → OTLP.
- **Process**: Trunk-based; semantic-release; Keep a Changelog; ADR-лог.
- **Flags/Delivery**: Unleash; Blue-Green для API, Canary для LLM-шаблонов/моделей.
- **Security**: GitHub OIDC→Cloud; SOPS для секретов; OWASP API Top-10 (2023) чек-лист; Telegram initData — только серверная валидация.
- **Memory/RAG**: pgvector + гибрид BM25/вектор, RRF; k_vector 8–12; rerank nano по top-N; запись в память только движок/редактор.
- **Gen**: профили (Scene/Combat/Social/Epilogue), strict JSON-ответы; tool_choice=auto; деградации без лора включены.

**Зачем**: снимаем «скользящие» решения, сокращаем число развилок для ИИ.  
**Проверка**: чек-листы на PR, спектральные правила, тесты-«золото».

## 7.5 Событийная шина и очереди (исполнительно)

**MVP-транспорт**: Redis Streams (просто, быстро, хватает для объёмов MVP).  
**Эволюция**: при росте — Kafka (строгие партиции/ретенции).  
**Ключи порядка**: campaign_id/party_id.  
**Доставка**: at-least-once; ретраи с экспоненциальной задержкой; DLQ.  
**Идемпотентность потребителей**: store-once по event.id.  
**Расширения**: trace_id (копия из traceparent).  
**Зачем**: простая и предсказуемая работа без дублей и «переигрываний».  
**Проверка**: хаос-тесты дубликатов/переупорядочивания, метрики DLQ-rate.

## 7.6 Память37 — в разработке и рантайме (клей с Гл.8)

- **В разработке**: контракт-фикстуры индексов (knowledge.yaml), эмуляторы стореджей, «golden» ретрив-кейсы (запрос→ожидаемые чанки).
- **В рантайме**: сборка промпта по 8.6; гибридный поиск; LLM-rerank; строгие лимиты токенов по профилю.
- **Запись**: только движок после хода/события (Episodic Summary, NPC disposition deltas, ArtCard).
- **Зачем**: предотвращение самозаписи ИИ, гарантии консистентности, трассируемость знаний.
- **Проверка**: unit на ретрив; метрики hit-rate, contradiction-rate; smoke-сводки в индексах.

## 7.7 Генеративные слои (клей с Гл.9)

- **Профили**: Scene/Combat/Social/Epilogue с собственными температурами/бюджетами.
- **Строгие ответы**: response_format=JSON Schema strict; схемы лежат в /contracts/schemas/….
- **Инструменты (MCP)**: rules_lookup, dice_roll, lore_search, lore_assert, npc_profile, session_fetch, art_suggest — tool_choice=auto.
- **Деградации**: недоступен лор → только SRD+state; недоступен IMG → UI fallback с повтором.
- **Зачем**: модель не «придумывает цифры», только нарратив; стабильная UX-стоимость.
- **Проверка**: контракт-тесты на JSON-схемы; метрики длины/тошноты/повторов; A/B шаблонов.

## 7.8 Медиа-пайплайн (клей с Гл.5)

- **Очереди per-тип** (tts/asr/img/avatar) + приоритеты (realtime/standard/bulk).
- **Кэш**: ключи по хэшу параметров запроса; TTL по типам; CDN signed URLs.
- **Транскодер**: вход PNG/JPEG/WEBP/base64 → стандарт: AVIF/WebP (фоны), PNG (альфа).
- **Модерация**: перцептуальные хэши + авто-классификаторы + ручная проверка краёв.
- **Зачем**: экономия бюджета, стабильные задержки, безопасность.
- **Проверка**: p95 для TTS/ASR/IMG, cache-hit, DLQ-rate, moderation-flags.

## 7.9 Безопасность (клей с Гл.6)

- **Auth**: Telegram initData — серверная валидация подписи/свежести; короткий JWT (kid, jti, ротация), RBAC (player/gm/author/admin).
- **API**: OWASP API Top-10 чек-лист в PR; rate-limits; HMAC-вебхуки (ts+body, окно 5 мин, constant-time).
- **Секреты**: SOPS/KMS; .env только пример; доступ в прод — SSO+MFA; все админ-действия — аудит.
- **Зачем**: минимизация атак и утечек, воспроизводимость расследований.
- **Проверка**: секрет-сканеры (gitleaks/ggshield), pentest чек-лист, алерты аномалий.

## 7.10 Наблюдаемость (клей с Гл.6/10)

- **Трассировка**: W3C Trace Context, trace_id в ошибках и CloudEvents.
- **OTel**: http.\*, db.\*, queue.\*, llm.\*, media.\*; экспортер OTLP.
- **SLO**: p95 (LLM/Media), error-rate, queue-depth, DLQ-rate, cost/turn; алерты по error-budget.
- **Дашборды**: Run/Turns, Party-sync, Media, Billing.
- **Зачем**: видимость узких мест, предиктивные инциденты.
- **Проверка**: synthetic checks (кроны эталонных запросов), отчёты недельные.

## 7.11 CI/CD и релизы (клей с Гл.6/10)

- **CI**: матрицы Python/Node; кэш зависимостей; jobs: lint/test/contracts; migrations dry-run; Pact verify.
- **Security**: OIDC в deploy-джобе; SBOM (Syft), vuln-скан (Trivy/Grype) — gates.
- **Release**: semantic-release (SemVer из Conventional Commits), GitHub Releases + CHANGELOG.
- **Deploy**: Blue-Green для API/БД (expand/contract миграции), Canary для рискованных LLM-изменений.
- **Зачем**: быстрые, безопасные, откатываемые релизы.
- **Проверка**: «зелёный» конвейер, кнопка Rollback, канареечные метрики.

## 7.12 Feature Flags

- **Платформа**: Unleash (OSS), таргетинг по user/campaign, аудит включений.
- **Правило**: фичфлаги **не** меняют баланс/шансы; только включают/выключают функционал/шаблоны.
- **Зачем**: изоляция незавершённых фич в trunk-потоке.
- **Проверка**: флаг-матрица по окружениям; журнал изменений.

## 7.13 HITL-гейты и самопроверки агента

- **Перед кодом**: Spec Writer обязан приложить: схему/пример, Spectral-лог, CloudEvents типы.
- **Перед merge**: Reviewer заполняет чек-лист (ниже).
- **Перед релизом**: Releaser отмечает Blue-Green/Canary plan, SBOM, vuln-скан, миграции expand/contract.
- **Зачем**: систематическая защита от «галлюцинаций» и регрессий.
- **Проверка**: шаблоны заполнены; отклонения — блокирующие.

**Чек-лист Reviewer (выжимка):**

- Контракты: OAS 3.1 валиден? примеры покрывают edge-кейсы?
- Идемпотентность: есть Idempotency-Key на write?
- Трассировка: trace_id сквозной?
- Безопасность: initData валидируется? 429 + Retry-After соблюдены?
- Память/генерация: респонсы строго по JSON-схемам? ретрив использован?
- Тесты: юнит/контракт/интеграция зелёные? e2e покрывает happy-path?

## 7.14 Опции дизайна, закреплённые решением

- **SSE vs WebSocket**: **SSE** по умолчанию для push (простота, авто-reconnect). WebSocket — только если нужен двусторонний real-time канал.
- **Redis Streams vs RabbitMQ vs Kafka**: **Redis Streams (MVP)**; миграция в **Kafka** при росте и необходимости горизонтали.
- **pgvector vs внешняя векторная БД**: **pgvector** (простота, транзакционность) на MVP; внешний движок — при экстремумах объёма/латентности.
- **JSON Merge Patch vs JSON Patch**: **Merge Patch** (проще для типичных PATCH).
- **Blue-Green vs Canary**: **Blue-Green** — дефолт; **Canary** — для рискованных LLM/шаблонов.

**Зачем**: снимаем «раскачку» вокруг типовых развилок.  
**Проверка**: ADR записан для каждого решения; обратимость описана.

## 7.15 Риски и смягчения (оперативно)

- **Дрейф тона/канона** → строгие профили, memory-retrieval, lore_assert, A/B, golden-сцены.
- **Дубли медиа/взрыв бюджета** → кэш по хэшу, TTL, приоритеты очередей, «геройские» сцены — quality=medium только по триггерам.
- **Несовместимость API** → Spectral + контрактные тесты + SemVer.
- **«Забывчивость» NPC** → Episodic Summary + NPC disposition deltas; запрет самозаписи LLM.
- **Инциденты в проде** → SLO-алерты, Blue-Green откат, DR-план (PITR, версии медиа).

## 7.16 Definition of Ready / Definition of Done

**DoR (на задачу):**

- Есть ADR/ссылка на решение (если нужно).
- Контракты/схемы/события описаны и провалидированы.
- Тест-план ясен (юнит/контракт/интеграция/E2E).
- Фичфлаги и миграции (если есть) спланированы.

**DoD (на задачу):**

- Линт/формат/тесты зелёные; покрытие ключевого домена ≥ порога.
- OpenAPI валиден; SDK обновлены; goldens обновлены.
- OTel-трейсы видны, метрики инкрементируются.
- CHANGELOG/релиз-ноты/ADR обновлены; SBOM/сканы пройдены.
- Документация UI/UX (если фронт) и примеры запросов/ответов приложены.

## 7.17 Мини-плейбуки для агентов (шаги и подсказки)

### 7.17.1 Planner → Spec Writer

- Прочитай соответствующие разделы Гл.1–6, 8–10; сформируй список сущностей/операций.
- Сначала опиши **схемы** (JSON Schema) и **события** (CloudEvents) → **OpenAPI**.
- Добавь **goldens**: 3–5 типовых запросов/ответов и 3–5 событий.
- Запусти make contracts:validate (Spectral/ajv).
- Смысл: закладываем интерфейсы, экономим время кодера/тестера.

### 7.17.2 Coder

- Сгенерируй SDK из /contracts. Не изобретай клиентов вручную.
- Реализуй контроллеры/хендлеры тонкими слоями, бизнес-правила выноси в сервисы.
- Добавь Idempotency-Key, Retry-After, traceparent; учитывай cursor-пагинацию.
- В media — кэш по хэшу, очереди, статусы 202→events.
- Смысл: воспроизводимый код вокруг «твёрдых» контрактов.

### 7.17.3 Reviewer

- Пройди чек-лист (7.13).
- Проверь, что **LLM-ответы** валидируются по схеме и **не содержат** «магических чисел» (все числа — из движка/инструментов).
- Смысл: остановить регресс/дрейф до релиза.

### 7.17.4 Tester

- Юнит-тесты на домен/эффекты; контрактные — на OAS/CloudEvents «goldens»; интеграция — на auth/initData, SSE; минимальный E2E: вертикальный срез.
- Нагрузка: burst/sustained для очередей; реконнекты SSE/WebSocket; деградации провайдера.
- Смысл: покрыть реальные риски, не раздувая e2e.

### 7.17.5 Releaser

- semantic-release: версии/релиз-ноты; SBOM + vuln-сканы — gates.
- Blue-Green: smoke на green; переключение; кнопка отката.
- Canary (если шаблоны/модели): 5%→25%→50%→100%, метрики/авто-стоп.
- Смысл: безопасная поставка без простоя.

## 7.18 Шаблоны (фрагменты для репозитория)

**PR template (выжимка):**

\## Что и зачем

\- Короткий контекст, ссылка на ADR/эпик

\## Контракты

\- \[ \] OpenAPI 3.1 обновлён

\- \[ \] JSON Schema/CloudEvents + goldens

\- \[ \] Spectral/ajv пройдены

\## Качество и безопасность

\- \[ \] Idempotency-Key / Retry-After / traceparent

\- \[ \] OWASP API Top-10 отмечены

\- \[ \] Трассы/метрики видны

\## Тесты

\- \[ \] Юнит (N)

\- \[ \] Контрактные (N)

\- \[ \] Интеграционные (N)

\- \[ \] E2E (если нужно)

\## Деплой

\- \[ \] Миграции expand/contract

\- \[ \] Feature flags

\- \[ \] Release notes/CHANGELOG

**ADR template (выжимка):**

\# ADR-00NN: &lt;Решение&gt;

Дата: YYYY-MM-DD

Контекст: (проблема/варианты/ограничения)

Решение: (выбранный вариант + почему)

Последствия: (trade-offs)

Альтернативы: (кратко)

Связанные документы: (главы/контракты/PR)

## 7.19 Что именно должно появиться в репозитории после завершения «Главы 7» (артефакты)

- /contracts: OpenAPI 3.1 v1, JSON Schema моделей, CloudEvents типы, spectral.yaml, goldens (REST/events).
- /packages/@rpg-contracts: автоген SDK (TS/Python) + типы.
- /packages/memory37: интерфейсы/адаптеры, policies, конфиги индексов (knowledge.yaml), тест-стабы.
- /packages/genlayers: профили промптов, JSON-схемы ответов, MCP-описания tools, A/B scaffolding.
- /services/\*: минимальные скелеты с OTel-middleware, auth, rate-limits, SSE.
- /apps/webapp: каркас экранов, i18n-файлы, состояния.
- .github: ci.yml (lint/test/contracts), release.yml (semantic-release), deploy.yml (Blue-Green/Canary, OIDC).
- /docs/ADRs: ADR-ы по ключевым решениям (SSE, Streams, pgvector, Merge Patch, Blue-Green/Canary).
- Чек-листы Security & SLO, Test Plan, DoR/DoD, PR-template, Incident playbook.

## 7.20 Пояснение «зачем всё это» в одном абзаце

Мы закрепили у агента «рельсы»: **контракты → память → генерация** под строгие схемы, с **идемпотентностью, трассировкой и тестами**, чтобы исключить контекстные галлюцинации и регрессии. Процесс **trunk-based** с фичфлагами и безопасными релизами делает поставку частой и обратимой. «Память37» гарантирует канон и непротиворечивость, а медиа-пайплайн — предсказуемую стоимость и задержки. Всё это объединено наблюдаемостью и безопасностью на уровне индустриальных практик — так ИИ-разработчик сможет уверенно собирать даже большой продукт, не теряясь в деталях.

### Итог/Validation

- **Согласованность**: глава 7 сшивает 1–6 (геймдизайн → UX → данные → контракты → медиа → операции) с 8–10 (Память37, Ген-слои, Процессы/кодовая база).
- **Неопределённость**: ключевые развилки закреплены нормами; чек-листы и артефакты минимизируют риск до целевых ~0.02.
- **Готовность к применению**: документ самодостаточен — из него агент и куратор могут прямо работать по шагам и выпускать вертикальный срез.